import{B as ae,F as Ot,M as S,V as F,G as tt,a as St,C as R,b as T,R as le,Q as ce,E as Ft,c as At,d as st,T as he,e as de,N as Wt,S as ue,f as j,D as pe,A as fe,g as Ht,h as Ut,i as Nt,j as ye,k as me,P as ge,W as be,l as Me,H as we}from"./three-DJZeHXKL.js";import{B as ot,S as jt,V as W,M as vt,a as gt,C as Zt,W as xe,b as ke}from"./cannon-DbeJiobQ.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const b=16,J=256,pt=18,Kt=8;class Se{constructor(t,e,s){this.x=t,this.z=e,this.textureManager=s,this.data=new Uint8Array(b*J*b),this.mesh=null,this.waterMesh=null,this.isDirty=!0,this.heightMap=new Int16Array(b*b),this.heightMap.fill(-1),this.genVersion=0}generate(t,e,s=0,i=0){this.data.fill(0),this.heightMap.fill(-1),this.genVersion=s;const o=h=>(h|=0,h^=h>>>16,h=Math.imul(h,2146121005),h^=h>>>15,h=Math.imul(h,2221713035),h^=h>>>16,h>>>0),r=(h,u,p,f=0)=>o((i|0)^Math.imul(h|0,374761393)^Math.imul(u|0,668265263)^Math.imul(p|0,2147483647)^(f|0))/4294967296,a=(h,u,p=4,f=2,m=.5)=>{let g=1,M=1,v=0,w=0;for(let x=0;x<p;x++)v+=g*t(h*M,u*M),w+=g,g*=m,M*=f;return w>0?v/w:0},n=new Uint8Array(b*b);for(let h=0;h<b;h++)for(let u=0;u<b;u++){const p=this.x*b+h,f=this.z*b+u,m=a(p/400,f/400,5),g=a(p/140,f/140,5),M=a(p/45,f/45,3),v=a(p/300,f/300,4)+.15,w=Math.abs(t(p/150,f/150)),x=w<.06?(.06-w)*90:0,L=1-Math.abs(t(p/100,f/100)),A=Math.max(0,m*.5+.5-.2);let I=20+(m*.5+.5)*20+(g*.5+.5)*15+(M*.5+.5)*5+A*L*50-x;I=Math.min(J-32,Math.max(6,Math.floor(I)));let E="plains";I<=pt+2?(E="shore",n[u*b+h]=4):I>pt+45?(E="mountain",n[u*b+h]=3):v<-.4?(E="desert",n[u*b+h]=2):v>.2?(E="forest",n[u*b+h]=1):(E="plains",n[u*b+h]=0);const N=u*b+h;this.heightMap[N]=Math.max(0,I-1);for(let k=0;k<J;k++){let C=0,O=!1;k<I-5&&e(p/30,k/25,f/30)>.6&&(O=!0),O?k<=Kt?r(p,k,f,101)<.12&&(C=15):k<pt&&(C=6):k<3?C=9:k<I-4?(C=3,k>=5&&k<=70&&e(p/15,k/15,f/15)>.7&&(C=40),k>=5&&k<=50&&e(p/18,k/18,f/18)>.75&&(C=41),k>=5&&k<=16&&e(p/25,k/25,f/25)>.82&&(C=43)):k<I-1?C=E==="desert"||E==="shore"?5:1:k===I-1&&(E==="desert"||E==="shore"?C=5:E==="mountain"?C=3:C=2),C===0&&k<=pt&&k>=I&&(C=6),C===0&&k<=Kt&&r(p,k,f,102)<.02&&(C=15),C!==0&&this.setBlock(h,k,u,C,{skipHeightUpdate:!0})}}this.rebuildHeightMap();const c=(h,u)=>{const p=this.getSurfaceHeight(h,u);return p===null?!1:this.getBlock(h,p,u)===2&&p>pt+2},l=(h,u)=>this.getSurfaceHeight(h,u);for(let h=2;h<b-2;h++)for(let u=2;u<b-2;u++){if(!c(h,u))continue;const p=l(h,u);let f=!0;for(let w=-1;w<=1&&f;w++)for(let x=-1;x<=1;x++){if(!c(h+w,u+x)){f=!1;break}const L=l(h+w,u+x);if(L===null||Math.abs(L-p)>2){f=!1;break}}if(!f)continue;const m=n[u*b+h];let g=0;if(m===1)g=.08;else if(m===0)g=.005;else if(m===3)g=.01;else continue;const M=this.x*b+h,v=this.z*b+u;r(M,p|0,v,201)>g||this.generateTree(h,p+1,u,i)}let d=0;for(let h=0;h<n.length;h++)if(n[h]===1){d=0;break}for(let h=0;h<40&&d<2;h++){const u=r(this.x,h,this.z,301),p=r(this.z,h,this.x,302),f=2+Math.floor(u*(b-4)),m=2+Math.floor(p*(b-4));if(n[m*b+f]!==1||!c(f,m))continue;const M=l(f,m);if(M===null)continue;const v=l(f+1,m),w=l(f,m+1);v===null||w===null||Math.abs(v-M)>2||Math.abs(w-M)>2||(this.generateTree(f,M+1,m,i),d++)}this.isDirty=!0}generateTree(t,e,s,i=0){const a=4+(n=>(n|=0,n^=n>>>16,n=Math.imul(n,2146121005),n^=n>>>15,n=Math.imul(n,2221713035),n^=n>>>16,n>>>0))((i|0)^Math.imul(this.x*16+t|0,374761393)^Math.imul(this.z*16+s|0,668265263))%3;for(let n=0;n<a;n++)this.setBlock(t,e+n,s,4);for(let n=t-2;n<=t+2;n++)for(let c=s-2;c<=s+2;c++)for(let l=e+a-2;l<=e+a+1;l++)(Math.abs(n-t)+Math.abs(c-s)<=2||l>e+a-1&&Math.abs(n-t)<=1&&Math.abs(c-s)<=1)&&this.getBlock(n,l,c)===0&&this.setBlock(n,l,c,7)}getBlock(t,e,s){if(t<0||t>=b||e<0||e>=J||s<0||s>=b)return 0;const i=e*b*b+s*b+t;return this.data[i]}setBlock(t,e,s,i,o={}){if(t<0||t>=b||e<0||e>=J||s<0||s>=b)return;const r=e*b*b+s*b+t;this.data[r]=i,o.skipHeightUpdate||this.updateColumnHeight(t,s),this.isDirty=!0}updateColumnHeight(t,e){if(t<0||t>=b||e<0||e>=b)return;const s=e*b+t;for(let i=J-1;i>=0;i--){const o=this.getBlock(t,i,e);if(o!==0&&o!==6&&o!==7){this.heightMap[s]=i;return}}this.heightMap[s]=-1}getSurfaceHeight(t,e){if(t<0||t>=b||e<0||e>=b)return null;const s=e*b+t,i=this.heightMap[s];if(i>=0)return i;for(let o=J-1;o>=0;o--){const r=this.getBlock(t,o,e);if(r!==0&&r!==6&&r!==7)return o}return null}rebuildHeightMap(){for(let t=0;t<b;t++)for(let e=0;e<b;e++)this.updateColumnHeight(t,e)}getBlockWithWorld(t,e,s,i){if(s<0||s>=J)return 0;if(e>=0&&e<b&&i>=0&&i<b)return this.getBlock(e,s,i);if(!t)return 0;const o=this.x*b+e,r=this.z*b+i;return t.getBlock(o,s,r)}buildMesh(t){if(!this.isDirty)return;const e=[],s=[],i=[],o=[];for(let a=0;a<J;a++)for(let n=0;n<b;n++)for(let c=0;c<b;c++){const l=this.getBlock(c,a,n);l!==0&&(this.shouldRenderFace(t,c+1,a,n,l)&&this.addFace(e,s,i,o,c,a,n,"right",l),this.shouldRenderFace(t,c-1,a,n,l)&&this.addFace(e,s,i,o,c,a,n,"left",l),this.shouldRenderFace(t,c,a+1,n,l)&&this.addFace(e,s,i,o,c,a,n,"top",l),this.shouldRenderFace(t,c,a-1,n,l)&&this.addFace(e,s,i,o,c,a,n,"bottom",l),this.shouldRenderFace(t,c,a,n+1,l)&&this.addFace(e,s,i,o,c,a,n,"front",l),this.shouldRenderFace(t,c,a,n-1,l)&&this.addFace(e,s,i,o,c,a,n,"back",l))}const r=new ae;return r.setAttribute("position",new Ot(e,3)),r.setAttribute("normal",new Ot(s,3)),r.setAttribute("uv",new Ot(i,2)),r.setIndex(o),this.mesh?(this.mesh.geometry.dispose(),this.mesh.geometry=r):(this.mesh=new S(r,this.textureManager.material),this.mesh.position.set(this.x*b,0,this.z*b),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0),this.isDirty=!1,this.mesh}shouldRenderFace(t,e,s,i,o){const r=this.getBlockWithWorld(t,e,s,i);return o===6&&r===6||o===15&&r===15||o===7&&r===7?!1:r===0||o!==6&&r===6||o!==15&&r===15||o!==7&&r===7}addFace(t,e,s,i,o,r,a,n,c){let l=[],d=[];const h=this.textureManager.getUVs(c,n),u=t.length/3;switch(n){case"right":l=[1,0,1,1,0,0,1,1,1,1,1,0],d=[1,0,0];break;case"left":l=[0,0,0,0,0,1,0,1,0,0,1,1],d=[-1,0,0];break;case"top":l=[0,1,1,1,1,1,0,1,0,1,1,0],d=[0,1,0];break;case"bottom":l=[0,0,0,1,0,0,0,0,1,1,0,1],d=[0,-1,0];break;case"front":l=[0,0,1,1,0,1,0,1,1,1,1,1],d=[0,0,1];break;case"back":l=[1,0,0,0,0,0,1,1,0,0,1,0],d=[0,0,-1];break}for(let p=0;p<l.length;p+=3)t.push(l[p]+o,l[p+1]+r,l[p+2]+a);for(let p=0;p<4;p++)e.push(...d);s.push(h[2].u,h[2].v),s.push(h[3].u,h[3].v),s.push(h[0].u,h[0].v),s.push(h[1].u,h[1].v),i.push(u,u+1,u+2),i.push(u+2,u+1,u+3)}}const $t=[{name:"Mountain Goat",color:15984117,size:.8,speed:1.4,heightOffset:.7,drop:{type:12,count:2}},{name:"Wild Boar",color:7951688,size:.9,speed:1,heightOffset:.6,drop:{type:11,count:2}},{name:"Peppy Chick",color:16763432,size:.5,speed:1.8,heightOffset:.5,drop:{type:13,count:3}}];class ve{constructor(t,e,s){this.profile=t,this.mesh=this.createMesh(),this.mesh.position.copy(e),this.spawnCenter=new F(e.x,e.y,e.z),this.direction=new F,this.moveTimer=0,this.heightOffset=t.heightOffset??.6,this.physicsWorld=s||null,this.body=null,this.physicsWorld&&(this.body=this.createPhysicsBody(e),this.physicsWorld.addBody(this.body)),this.chooseDirection()}createMesh(){const t=new tt,e=new St({color:this.profile.color,roughness:.85,metalness:.05}),s=new St({color:new R(this.profile.color).multiplyScalar(.55),roughness:.9,metalness:.02}),i=new St({color:1118481,roughness:.95,metalness:0}),o=this.profile.size,r=new T(o*1.15,o*.6,o*.75),a=new T(o*.55,o*.45,o*.55),n=new T(o*.18,o*.4,o*.18),c=new S(r,e);c.position.set(0,o*.38,0),c.castShadow=!0,c.receiveShadow=!0;const l=new S(a,e);l.position.set(0,o*.48,o*.62),l.castShadow=!0,l.receiveShadow=!0;const d=[],h=[[-o*.38,o*.12,-o*.25],[o*.38,o*.12,-o*.25],[-o*.38,o*.12,o*.25],[o*.38,o*.12,o*.25]];for(const[u,p,f]of h){const m=new S(n,s);m.position.set(u,p,f),m.castShadow=!0,m.receiveShadow=!0,d.push(m)}if(t.add(c,l,...d),this.profile.name.includes("Goat")){const u=new T(o*.12,o*.28,o*.12),p=new S(u,i),f=new S(u,i);p.position.set(-o*.16,o*.72,o*.72),f.position.set(o*.16,o*.72,o*.72),t.add(p,f)}else if(this.profile.name.includes("Boar")){const u=new T(o*.35,o*.25,o*.25),p=new S(u,s);p.position.set(0,o*.42,o*.92);const f=new T(o*.08,o*.12,o*.08),m=new S(f,i),g=new S(f,i);m.position.set(-o*.16,o*.32,o*.96),g.position.set(o*.16,o*.32,o*.96),t.add(p,m,g)}else if(this.profile.name.includes("Chick")){c.scale.set(.9,.85,.9),l.scale.set(.85,.85,.85),l.position.set(0,o*.52,o*.58);const u=new T(o*.18,o*.12,o*.18),p=new St({color:16757504,roughness:.7,metalness:0}),f=new S(u,p);f.position.set(0,o*.5,o*.85);const m=new T(o*.1,o*.28,o*.35),g=new S(m,e),M=new S(m,e);g.position.set(-o*.62,o*.42,o*.05),M.position.set(o*.62,o*.42,o*.05),t.add(f,g,M)}t.userData=t.userData||{},t.userData.animal=this;for(const u of t.children)u.userData=u.userData||{},u.userData.animal=this;return t.traverse(u=>{u.isMesh&&(u.castShadow=!0,u.receiveShadow=!0)}),t}createPhysicsBody(t){const e=Math.max(.2,this.profile.size*.35),s=new ot({mass:0,type:ot.KINEMATIC,position:new W(t.x,t.y,t.z),shape:new jt(e)});return s.fixedRotation=!0,s}chooseDirection(){const t=Math.random()-.5,e=Math.random()-.5;this.direction.set(t,0,e),this.direction.lengthSq()<.01&&this.direction.set(1,0,0),this.direction.normalize(),this.moveTimer=.8+Math.random()*1.8}update(t,e){this.moveTimer-=t,this.moveTimer<=0&&this.chooseDirection();const s=this.direction.clone().multiplyScalar(this.profile.speed*t);if(this.mesh.position.add(s),this.direction.lengthSq()>1e-4){const n=Math.atan2(this.direction.x,this.direction.z);this.mesh.rotation.y=n}const i=this.mesh.position.x-this.spawnCenter.x,o=this.mesh.position.z-this.spawnCenter.z;if(Math.sqrt(i*i+o*o)>12){const n=new F(-i,0,-o).normalize();this.mesh.position.addScaledVector(n,this.profile.speed*t*1.2),this.direction.copy(n)}const a=e.getSurfaceY(Math.floor(this.mesh.position.x),Math.floor(this.mesh.position.z));a!==null&&(this.mesh.position.y=a+1+this.heightOffset),this.body&&(this.body.position.set(this.mesh.position.x,this.mesh.position.y,this.mesh.position.z),this.body.aabbNeedsUpdate=!0)}}class Ce{constructor(t,e,s){this.scene=t,this.world=e,this.physicsWorld=s||null,this.animals=[],this.spawnTimer=0,this.maxAnimals=8}update(t,e){if(t){this.spawnTimer+=t,e&&this.spawnTimer>.9&&(this.spawnTimer=0,this.trySpawnNear(e));for(const s of this.animals)s.update(t,this.world)}}trySpawnNear(t){if(!(this.animals.length>=this.maxAnimals))for(let e=0;e<3;e++){const s=Math.floor(t.x+(Math.random()*32-16)),i=Math.floor(t.z+(Math.random()*32-16)),o=this.world.getSurfaceY(s,i);if(o===null)continue;const r=this.world.getBlock(s,o,i);if(r!==2&&r!==1||Math.random()>.35)continue;const a=$t[Math.floor(Math.random()*$t.length)];this.spawnAnimal(a,new F(s+.5,o+1,i+.5));break}}spawnAnimal(t,e){const s=new ve(t,e,this.physicsWorld);this.scene.add(s.mesh),this.animals.push(s)}raycast(t){if(this.animals.length===0)return null;const e=this.animals.map(o=>o.mesh),s=t.intersectObjects(e,!0);if(s.length===0)return null;let i=s[0].object;for(;i;){if(i.userData?.animal)return i.userData.animal;i=i.parent}return null}remove(t){const e=this.animals.indexOf(t);e!==-1&&(this.scene.remove(t.mesh),t.body&&this.physicsWorld&&this.physicsWorld.removeBody(t.body),this.animals.splice(e,1))}}class Ie{constructor(t,e,s=null){this.scene=t,this.textureManager=e,this.chunks=new Map,this.renderDistance=4,this.chunkSize=16,this.noise2D=null,this.noise3D=null,this.physicsWorld=s,this.animalManager=new Ce(t,this,s),this.seed=0,this.edits=new Map,this.generationVersion=8}getChunkKey(t,e){return`${t},${e}`}rebuildChunkMesh(t){if(!t)return;const e=t.buildMesh(this);e&&!e.parent&&this.scene.add(e)}clearAllChunks(){for(const[,t]of this.chunks)t.mesh&&(t.mesh.geometry.dispose(),this.scene.remove(t.mesh));this.chunks.clear()}setEditsFromSave(t){if(this.edits.clear(),!(!t||typeof t!="object"))for(const[e,s]of Object.entries(t))Array.isArray(s)&&this.edits.set(e,s)}exportEditsForSave(){const t={};for(const[e,s]of this.edits.entries())t[e]=s;return t}recordEdit(t,e,s,i,o,r){const a=this.getChunkKey(t,e);let n=this.edits.get(a);n||(n=[],this.edits.set(a,n));for(let c=0;c<n.length;c++){const l=n[c];if(l&&l[0]===s&&l[1]===i&&l[2]===o){l[3]=r;return}}n.push([s,i,o,r])}applyEditsToChunk(t){if(!t)return;const e=this.getChunkKey(t.x,t.z),s=this.edits.get(e);if(!(!s||s.length===0)){for(const i of s){if(!i||i.length<4)continue;const[o,r,a,n]=i;t.setBlock(o,r,a,n,{skipHeightUpdate:!0})}t.rebuildHeightMap(),t.isDirty=!0}}markNeighborsDirty(t,e){const s=[[t-1,e],[t+1,e],[t,e-1],[t,e+1]];for(const[i,o]of s){const r=this.chunks.get(this.getChunkKey(i,o));r&&(r.isDirty=!0)}}update(t,e,s=0){if(!this.noise2D||!this.noise3D)return;const i=Math.floor(t/this.chunkSize),o=Math.floor(e/this.chunkSize);for(let r=-this.renderDistance;r<=this.renderDistance;r++)for(let a=-this.renderDistance;a<=this.renderDistance;a++){const n=i+r,c=o+a,l=this.getChunkKey(n,c);if(!this.chunks.has(l)){const h=new Se(n,c,this.textureManager);h.generate(this.noise2D,this.noise3D,this.generationVersion,this.seed),this.applyEditsToChunk(h),this.rebuildChunkMesh(h),this.chunks.set(l,h),this.markNeighborsDirty(n,c),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(n-1,c))),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(n+1,c))),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(n,c-1))),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(n,c+1)))}const d=this.chunks.get(l);d&&d.genVersion!==this.generationVersion&&(d.generate(this.noise2D,this.noise3D,this.generationVersion,this.seed),this.applyEditsToChunk(d),this.rebuildChunkMesh(d),this.markNeighborsDirty(d.x,d.z),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(d.x-1,d.z))),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(d.x+1,d.z))),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(d.x,d.z-1))),this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(d.x,d.z+1))))}for(const[r,a]of this.chunks)Math.sqrt(Math.pow(a.x-i,2)+Math.pow(a.z-o,2))>this.renderDistance+2&&(a.mesh&&(a.mesh.geometry.dispose(),this.scene.remove(a.mesh)),this.chunks.delete(r));this.animalManager&&this.animalManager.update(s,{x:t,z:e})}getBlock(t,e,s){const i=Math.floor(t/this.chunkSize),o=Math.floor(s/this.chunkSize),r=`${i},${o}`,a=this.chunks.get(r);if(!a)return 0;const n=(t%this.chunkSize+this.chunkSize)%this.chunkSize,c=(s%this.chunkSize+this.chunkSize)%this.chunkSize;return a.getBlock(n,e,c)}setBlock(t,e,s,i,o={}){const{record:r=!0}=o,a=Math.floor(t/this.chunkSize),n=Math.floor(s/this.chunkSize),c=this.getChunkKey(a,n),l=this.chunks.get(c);if(!l)return;const d=(t%this.chunkSize+this.chunkSize)%this.chunkSize,h=(s%this.chunkSize+this.chunkSize)%this.chunkSize;l.setBlock(d,e,h,i),r&&this.recordEdit(a,n,d,e,h,i),this.rebuildChunkMesh(l);const u=d===0,p=d===this.chunkSize-1,f=h===0,m=h===this.chunkSize-1;u&&this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(a-1,n))),p&&this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(a+1,n))),f&&this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(a,n-1))),m&&this.rebuildChunkMesh(this.chunks.get(this.getChunkKey(a,n+1)))}getSurfaceY(t,e){const s=Math.floor(t/this.chunkSize),i=Math.floor(e/this.chunkSize),o=`${s},${i}`,r=this.chunks.get(o);if(!r)return null;const a=(t%this.chunkSize+this.chunkSize)%this.chunkSize,n=(e%this.chunkSize+this.chunkSize)%this.chunkSize;return r.getSurfaceHeight(a,n)}raycastAnimal(t){return this.animalManager?this.animalManager.raycast(t):null}removeAnimal(t){!this.animalManager||!t||this.animalManager.remove(t)}}class Te{constructor(t,e,s,i,o,r,a,n=null,c=null,l=null){this.scene=t,this.camera=e,this.physicsWorld=s,this.input=i,this.world=o,this.inventory=r,this.handManager=a,this.monsterManager=n,this.placeableObjects=c,this.dayNightManager=l;const d=.35,h=.5;this.playerMaterial=new vt("player"),this.blockMaterial=new vt("block"),this.body=new ot({mass:70,position:new W(0,80,0),fixedRotation:!0,material:this.playerMaterial}),this.body.addShape(new gt(new W(d,h,d))),this.body.addShape(new jt(d),new W(0,h,0)),this.body.addShape(new jt(d),new W(0,-h,0)),this.body.linearDamping=.99,this.physicsWorld.addContactMaterial(new Zt(this.playerMaterial,this.blockMaterial,{friction:0,restitution:0})),this.physicsWorld.addBody(this.body),this.pitch=0,this.yaw=0,this.raycaster=new le,this.raycaster.far=6,this.miningProgress=0,this.miningTarget=null,this.isMining=!1,this.isLeftMouseDown=!1,this.isRightMouseDown=!1,this.maxHealth=20,this.health=20,this.maxHunger=20,this.hunger=20,this.hungerTimer=0,this.regenTimer=0,this.damageFlashTimer=0,document.addEventListener("mousemove",u=>this.onMouseMove(u)),document.addEventListener("mousedown",u=>this.onMouseDown(u)),document.addEventListener("mouseup",u=>this.onMouseUp(u))}takeDamage(t){this.health=Math.max(0,this.health-t),this.damageFlashTimer=.3,this.updateHealthUI&&this.updateHealthUI(),this.health<=0&&this.onDeath()}heal(t){this.health=Math.min(this.maxHealth,this.health+t),this.updateHealthUI&&this.updateHealthUI()}eat(t,e=0){this.hunger=Math.min(this.maxHunger,this.hunger+t),e>0&&this.heal(e),this.updateHealthUI&&this.updateHealthUI()}onDeath(){console.log("Ð“Ñ€Ð°Ð²ÐµÑ†ÑŒ Ð¿Ð¾Ð¼ÐµÑ€!"),this.health=this.maxHealth,this.hunger=this.maxHunger,this.body.position.set(0,80,0),this.body.velocity.set(0,0,0),this.updateHealthUI&&this.updateHealthUI()}getFoodValue(t){return{11:{hunger:3,heal:0,name:"Ð¡Ð¸Ñ€Ðµ Ð¼'ÑÑÐ¾"},16:{hunger:8,heal:4,name:"Ð¡Ð¼Ð°Ð¶ÐµÐ½Ðµ Ð¼'ÑÑÐ¾"},17:{hunger:5,heal:2,name:"Ð¥Ð»Ñ–Ð±"}}[t]||null}showMessage(t){let e=document.getElementById("player-message");e||(e=document.createElement("div"),e.id="player-message",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -100px)",e.style.background="rgba(0, 0, 0, 0.8)",e.style.color="white",e.style.padding="12px 24px",e.style.borderRadius="8px",e.style.fontSize="16px",e.style.fontWeight="bold",e.style.pointerEvents="none",e.style.zIndex="1001",e.style.display="none",document.body.appendChild(e)),e.textContent=t,e.style.display="block",setTimeout(()=>{e.style.display="none"},2e3)}onMouseMove(t){if(!this.input.isLocked)return;const e=.002;this.yaw-=t.movementX*e,this.pitch-=t.movementY*e,this.pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.pitch));const s=new ce;s.setFromEuler(new Ft(this.pitch,this.yaw,0,"YXZ")),this.camera.quaternion.copy(s)}getBlockHardness(t){const e={0:0,1:.5,2:.6,3:1.5,4:2,5:.5,6:0,7:.2,8:2,9:-1,40:3,41:3,44:2};return e[t]!==void 0?e[t]:1}getBlockToolType(t){const e={1:"shovel",2:"shovel",3:"pickaxe",4:"axe",5:"shovel",99:"any",8:"axe",40:"pickaxe",41:"pickaxe",44:"pickaxe"};return t===7?"any":e[t]||"any"}getBlockMinTier(t){return{3:"wood",40:"wood",41:"stone",43:"iron",44:"wood"}[t]||null}canHarvestBlock(t,e){const s=this.getBlockMinTier(t);if(!s)return!0;if(!e)return!1;const i=["wood","stone","iron","diamond"],o=i.indexOf(e.tier.name||e.tier),r=i.indexOf(s);return o>=r}calculateMiningTime(t,e){const s=this.getBlockHardness(t);if(s<=0)return 0;if(s<0)return 1/0;const i=this.getBlockToolType(t);let o=1;if(e)if(i==="any"||e.type===i){const a={wood:2,stone:4,iron:6,diamond:8},n=e.tier.name||e.tier;o=a[n]||1}else o=1;return s*1.5/o}onMouseDown(t){if(this.input.isLocked){if(t.button===0){if(this.isLeftMouseDown=!0,this.raycaster.setFromCamera(new At(0,0),this.camera),this.placeableObjects){const s=this.placeableObjects.raycastObject(this.raycaster);if(s){this.handManager&&this.handManager.startSwing(),this.placeableObjects.removeObject(s.position.x,s.position.y,s.position.z),this.inventory.add(s.type,1);return}}if(this.monsterManager){const s=this.monsterManager.raycastMonster(this.raycaster);if(s){this.handManager&&this.handManager.startSwing();const i=this.inventory.getSelectedItem();let o=1;if(i){const r=this.inventory.uiManager.getToolInfo(i.type);if(r)if(r.type==="sword"){const a={wood:5,stone:6,iron:7,diamond:8},n=r.tier?.name||r.tier||"wood";o=a[n]||5}else if(r.type==="axe"){const a={wood:4,stone:5,iron:6,diamond:7},n=r.tier?.name||r.tier||"wood";o=a[n]||4}else o=2}this.monsterManager.damageMonster(s,o),s.health<=0&&s.profile?.drop&&this.inventory.add(s.profile.drop.type,s.profile.drop.count);return}}const e=this.world.raycastAnimal(this.raycaster);e&&(this.handManager&&this.handManager.startSwing(),this.world.removeAnimal(e),e.profile?.drop&&this.inventory.add(e.profile.drop.type,e.profile.drop.count))}else if(t.button===2){if(this.isRightMouseDown=!0,this.raycaster.setFromCamera(new At(0,0),this.camera),this.placeableObjects){const i=this.placeableObjects.raycastObject(this.raycaster);if(i){if(i.type===72){this.placeableObjects.toggleDoor(i.position.x,i.position.y,i.position.z);return}else if(i.type===70){this.dayNightManager&&this.dayNightManager.isNight()?(this.placeableObjects.sleep(this.dayNightManager),this.showMessage("Ð’Ð¸ Ð¿Ñ€Ð¾ÐºÐ¸Ð½ÑƒÐ»Ð¸ÑÑŒ!")):this.showMessage("ÐœÐ¾Ð¶Ð½Ð° ÑÐ¿Ð°Ñ‚Ð¸ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð²Ð½Ð¾Ñ‡Ñ–");return}else if(i.type===71){this.openChest&&this.openChest(i);return}}}const e=this.inventory.getSelectedItem();if(e){const i=this.getFoodValue(e.type);if(i){this.hunger<this.maxHunger&&(this.eat(i.hunger,i.heal),this.inventory.remove(e.type,1),this.handManager&&this.handManager.startSwing());return}}const s=this.raycastBlockVoxel(this.raycaster.far);if(s){const i=s.x+s.normal.x,o=s.y+s.normal.y,r=s.z+s.normal.z,a=this.inventory.getSelectedBlock();if(a>=70&&a<=72){if(this.placeableObjects){if(this.world.getBlock(i,o,r)!==0||this.placeableObjects.isPositionOccupied(i,o,r)||a===72&&(this.world.getBlock(i,o+1,r)!==0||this.placeableObjects.isPositionOccupied(i,o+1,r)))return;const n=Math.round(this.yaw/(Math.PI/2))*(Math.PI/2);this.inventory.remove(a,1)&&(this.placeableObjects.placeObject(a,i,o,r,n)?this.handManager&&this.handManager.startSwing():this.inventory.add(a,1))}}else if(a>=1&&a<=15||a>=40&&a<=44){if(this.world.getBlock(i,o,r)!==0)return;this.inventory.remove(a,1)&&(this.world.setBlock(i,o,r,a),this.handManager&&this.handManager.startSwing())}}}}}onMouseUp(t){t.button===0&&(this.isLeftMouseDown=!1,this.isMining=!1,this.miningProgress=0,this.miningTarget=null,this.updateMiningIndicator(0)),t.button===2&&(this.isRightMouseDown=!1)}update(t){if(this.handManager){const n=this.inventory.getSelectedItem();this.handManager.update(t,n)}if(this.isLeftMouseDown){this.handManager&&!this.handManager.isSwinging&&this.handManager.startSwing();const n=this.raycastBlockVoxel(this.raycaster.far);if(n){const c=n.x,l=n.y,d=n.z,h=this.world.getBlock(c,l,d);if(h!==0&&h!==9){(!this.miningTarget||this.miningTarget.x!==c||this.miningTarget.y!==l||this.miningTarget.z!==d)&&(this.miningTarget={x:c,y:l,z:d,blockType:h},this.miningProgress=0,this.isMining=!0);const u=this.inventory.getSelectedItem(),p=u?this.inventory.uiManager.getToolInfo(u.type):null,f=this.calculateMiningTime(h,p);if(f===1/0)this.miningProgress=0;else if(this.miningProgress+=t,this.updateMiningIndicator(this.miningProgress/f),this.miningProgress>=f){if(this.canHarvestBlock(h,p)){let g=h,M=1;h===2&&(g=1),h===3&&(g=44),h===7&&Math.random()>.3&&(M=0),h===40&&(g=40),h===41&&(g=41),h===43&&(g=43),M>0&&this.inventory.add(g,M)}this.world.setBlock(c,l,d,0),p&&this.inventory.damageTool(1),this.miningProgress=0,this.miningTarget=null,this.isMining=!1,this.updateMiningIndicator(0)}}else this.isMining=!1,this.miningProgress=0,this.updateMiningIndicator(0)}else this.isMining=!1,this.miningProgress=0,this.updateMiningIndicator(0)}else this.isMining&&(this.isMining=!1,this.miningProgress=0,this.updateMiningIndicator(0));this.input.isKeyDown("Space")&&Math.abs(this.body.velocity.y)<.1&&(this.body.velocity.y=12);const e=new F((this.input.isKeyDown("KeyD")?1:0)-(this.input.isKeyDown("KeyA")?1:0),0,(this.input.isKeyDown("KeyS")?1:0)-(this.input.isKeyDown("KeyW")?1:0)),s=this.input.isKeyDown("ShiftLeft")||this.input.isKeyDown("ShiftRight"),i=10,o=s?i*1.6:i,r=new F;if(e.lengthSq()>0){const n=e.clone().normalize().applyEuler(new Ft(0,this.yaw,0));r.copy(n).multiplyScalar(o)}this.body.velocity.x=st.lerp(this.body.velocity.x,r.x,.3),this.body.velocity.z=st.lerp(this.body.velocity.z,r.z,.3);const a=new F().copy(this.body.position).add(new F(0,.9,0));this.camera.position.lerp(a,.4),this.hungerTimer+=t,this.hungerTimer>=10&&(this.hunger=Math.max(0,this.hunger-.5),this.hungerTimer=0,this.updateHealthUI&&this.updateHealthUI(),this.hunger<=0&&this.takeDamage(1)),this.hunger>=18&&this.health<this.maxHealth&&(this.regenTimer+=t,this.regenTimer>=4&&(this.heal(1),this.hunger=Math.max(0,this.hunger-1),this.regenTimer=0)),this.damageFlashTimer>0&&(this.damageFlashTimer-=t,this.updateDamageFlash()),this.updateFoodIndicator(),this.updatePhysicsColliders()}updateFoodIndicator(){let t=document.getElementById("food-indicator");const e=this.inventory.getSelectedItem(),s=e?this.getFoodValue(e.type):null;s&&this.hunger<this.maxHunger?(t||(t=document.createElement("div"),t.id="food-indicator",t.style.position="fixed",t.style.bottom="80px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="8px 16px",t.style.borderRadius="5px",t.style.fontSize="14px",t.style.pointerEvents="none",t.style.zIndex="1000",document.body.appendChild(t)),t.style.display="block",t.textContent=`ðŸ– ÐŸÐšÐœ Ð´Ð»Ñ Ñ—Ð¶Ñ–: +${s.hunger} Ð³Ð¾Ð»Ð¾Ð´Ñƒ${s.heal>0?`, +${s.heal} HP`:""}`):t&&(t.style.display="none")}updateDamageFlash(){const t=document.getElementById("damage-overlay");if(!t){const s=document.createElement("div");s.id="damage-overlay",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="rgba(255, 0, 0, 0)",s.style.pointerEvents="none",s.style.zIndex="999",document.body.appendChild(s);return}const e=Math.max(0,this.damageFlashTimer/.3)*.4;t.style.backgroundColor=`rgba(255, 0, 0, ${e})`}raycastBlockVoxel(t=6){this.raycaster.setFromCamera(new At(0,0),this.camera);const e=this.raycaster.ray.origin,s=this.raycaster.ray.direction;let i=Math.floor(e.x),o=Math.floor(e.y),r=Math.floor(e.z);const a=s.x>0?1:s.x<0?-1:0,n=s.y>0?1:s.y<0?-1:0,c=s.z>0?1:s.z<0?-1:0,l=(w,x)=>{if(x===0)return 1/0;const L=Math.floor(w)===w;return x>0?((L?0:1)+Math.floor(w)-w)/x+1e-9:(w-Math.floor(w))/-x+1e-9};let d=l(e.x,s.x),h=l(e.y,s.y),u=l(e.z,s.z);const p=a===0?1/0:Math.abs(1/s.x),f=n===0?1/0:Math.abs(1/s.y),m=c===0?1/0:Math.abs(1/s.z),g=this.world.getBlock(i,o,r);if(g!==0&&g!==6&&g!==15)return{x:i,y:o,z:r,normal:{x:0,y:0,z:0}};let M=0,v=null;for(;M<=t;){d<h?d<u?(i+=a,M=d,d+=p,v="x"):(r+=c,M=u,u+=m,v="z"):h<u?(o+=n,M=h,h+=f,v="y"):(r+=c,M=u,u+=m,v="z");const w=this.world.getBlock(i,o,r);if(w!==0&&w!==6&&w!==15){const x={x:0,y:0,z:0};return v==="x"&&(x.x=-a),v==="y"&&(x.y=-n),v==="z"&&(x.z=-c),{x:i,y:o,z:r,normal:x}}}return null}updateMiningIndicator(t){let e=document.getElementById("mining-progress");if(!e){e=document.createElement("div"),e.id="mining-progress",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, 60px)",e.style.width="200px",e.style.height="20px",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.border="2px solid #fff",e.style.display="none",e.style.zIndex="1000";const i=document.createElement("div");i.id="mining-progress-fill",i.style.height="100%",i.style.backgroundColor="#4caf50",i.style.width="0%",i.style.transition="width 0.1s",e.appendChild(i),document.body.appendChild(e)}const s=document.getElementById("mining-progress-fill");t>0?(e.style.display="block",s.style.width=`${Math.min(t*100,100)}%`):(e.style.display="none",s.style.width="0%")}updatePhysicsColliders(){const e=Math.floor(this.body.position.x),s=Math.floor(this.body.position.y),i=Math.floor(this.body.position.z);this.colliderMap||(this.colliderMap=new Map);const o=new Set;for(let r=e-2;r<=e+2;r++)for(let a=s-2;a<=s+2;a++)for(let n=i-2;n<=i+2;n++){const c=this.world.getBlock(r,a,n);if(c!==0&&c!==6&&c!==7&&c!==15){const l=`${r},${a},${n}`;if(o.add(l),!this.colliderMap.has(l)){const d=new ot({mass:0,position:new W(r+.5,a+.5,n+.5),shape:new gt(new W(.5,.5,.5)),material:this.blockMaterial});this.physicsWorld.addBody(d),this.colliderMap.set(l,d)}}}for(const[r,a]of this.colliderMap)o.has(r)||(this.physicsWorld.removeBody(a),this.colliderMap.delete(r))}}class De{constructor(){this.keys={},this.isLocked=!1,this.allowPointerLock=!0,document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.addEventListener("pointerlockchange",()=>this.onPointerLockChange()),document.addEventListener("click",t=>this.requestLock(t))}onKeyDown(t){this.keys[t.code]=!0}onKeyUp(t){this.keys[t.code]=!1}isKeyDown(t){return!!this.keys[t]}onPointerLockChange(){this.isLocked=document.pointerLockElement===document.body}requestLock(t){if(!this.allowPointerLock||this.isLocked)return;const e=t?.target;e&&e.closest&&e.closest("#inventory-screen, #hotbar")||!this.isLocked&&this.allowPointerLock&&document.body.requestPointerLock()}setPointerLockEnabled(t){this.allowPointerLock=t,!t&&document.pointerLockElement===document.body&&document.exitPointerLock()}}class ze{constructor(){this.loader=new he,this.material=null,this.transparentMaterial=null}load(){const t=document.createElement("canvas");t.width=128,t.height=128;const e=t.getContext("2d");e.fillStyle="#ff00ff",e.fillRect(0,0,128,128);const s=(r,a,n,c=.1,l="noise")=>{const d=r*16,h=a*16;e.fillStyle=n,e.fillRect(d,h,16,16);const u=e.getImageData(d,h,16,16),p=u.data;for(let f=0;f<p.length;f+=4){const m=f/4%16,g=Math.floor(f/4/16);let M=0;if(l==="noise")M=(Math.random()-.5)*255*c;else if(l==="bricks"){const v=Math.floor(g/4),w=m+v%2*4;M=g%4===0||w%8===0?-40:10}else if(l==="log")M=(Math.random()-.5)*30+(m%4===0?-20:0);else if(l==="rings"){const v=m-7.5,w=g-7.5,x=Math.sqrt(v*v+w*w);M=Math.sin(x*1.5)>0?-20:10}else l==="leaves"&&(M=Math.random()>.6?-30:10);p[f]=Math.min(255,Math.max(0,p[f]+M)),p[f+1]=Math.min(255,Math.max(0,p[f+1]+M)),p[f+2]=Math.min(255,Math.max(0,p[f+2]+M))}e.putImageData(u,d,h)},i=(r,a,n,c)=>{s(r,a,n,.15);const l=r*16,d=a*16;e.fillStyle=c;const h=[[4,4],[5,4],[4,5],[10,10],[11,10],[10,11],[11,11],[12,3],[13,3],[3,12]];for(const[u,p]of h)e.fillRect(l+u,d+p,1,1)};s(0,0,"#795548",.2),s(1,0,"#795548",.2),e.fillStyle="#4caf50",e.fillRect(16,0,16,4),e.fillRect(18,4,1,2),e.fillRect(21,4,2,3),e.fillRect(25,4,1,1),e.fillRect(29,4,2,4),s(2,0,"#4caf50",.15),s(3,0,"#9e9e9e",.15),s(0,1,"#5d4037",.1,"log"),s(1,1,"#5d4037",.1,"rings"),s(2,1,"#388e3c",.1,"leaves"),s(3,1,"#fff59d",.15),s(0,2,"#42a5f5",.05),s(1,2,"#a1887f",.1),e.fillStyle="#6d4c41",e.fillRect(16,32,16,1),e.fillRect(16,36,16,1),e.fillRect(16,40,16,1),e.fillRect(16,44,16,1),s(2,2,"#212121",.4),s(3,2,"#757575",.1,"bricks"),s(0,3,"#ff6d00",.1),e.fillStyle="#ffab00",e.fillRect(4,52,4,2),e.fillRect(10,58,3,3),i(1,3,"#9e9e9e","#212121"),i(2,3,"#9e9e9e","#d7ccc8"),i(3,3,"#9e9e9e","#00bcd4");const o=new de(t);return o.magFilter=Wt,o.minFilter=Wt,o.colorSpace=ue,o.generateMipmaps=!1,this.material=new j({map:o,side:pe,transparent:!1,alphaTest:0,depthTest:!0,depthWrite:!0}),this.material}getUVs(t,e){let s=0,i=0;switch(t){case 1:s=0,i=0;break;case 2:e==="top"?(s=2,i=0):e==="bottom"?(s=0,i=0):(s=1,i=0);break;case 3:s=3,i=0;break;case 4:e==="top"||e==="bottom"?(s=1,i=1):(s=0,i=1);break;case 5:s=3,i=1;break;case 6:s=0,i=2;break;case 7:s=2,i=1;break;case 8:s=1,i=2;break;case 9:s=2,i=2;break;case 15:s=0,i=3;break;case 40:s=1,i=3;break;case 41:s=2,i=3;break;case 43:s=3,i=3;break;case 44:s=3,i=2;break;default:s=0,i=0;break}const o=.125,r=s*o,a=1-(i+1)*o,n=.5/128,c=r+n,l=r+o-n,d=a+n,h=a+o-n;return[{u:c,v:h},{u:l,v:h},{u:c,v:d},{u:l,v:d}]}}class Ee{constructor(t){this.slots=new Array(36).fill(null),this.hotbarSlot=0,this.uiManager=t}add(t,e=1,s={}){const{skipUI:i=!1,durability:o=null}=s;let r=e;if(this.uiManager.getToolInfo(t)&&o!==null)for(let n=0;n<this.slots.length&&r>0;n++)this.slots[n]||(this.slots[n]={type:t,count:1,durability:o},r--);else{for(let n=0;n<this.slots.length&&r>0;n++){const c=this.slots[n];if(c&&c.type===t&&c.count<64&&!c.durability){const l=64-c.count,d=Math.min(l,r);c.count+=d,r-=d}}for(let n=0;n<this.slots.length&&r>0;n++)if(!this.slots[n]){const c=Math.min(64,r);this.slots[n]={type:t,count:c},r-=c}}return i||this.uiManager.updateInventoryUI(),r===0}remove(t,e,s={}){const{skipUI:i=!1}=s,o=this.slots[this.hotbarSlot];return o&&o.type===t&&o.count>=e?(o.count-=e,o.count===0&&(this.slots[this.hotbarSlot]=null),i||this.uiManager.updateInventoryUI(),!0):!1}consumeSlot(t,e=1){const s=this.slots[t];return!s||s.count<e?!1:(s.count-=e,s.count===0&&(this.slots[t]=null),!0)}canAdd(t,e=1){let s=0;for(const i of this.slots)if(i?i.type===t&&(s+=64-i.count):s+=64,s>=e)return!0;return!1}findHotbarSlotFor(t){let e=null;for(let s=0;s<9;s++){const i=this.slots[s];if(i&&i.type===t&&i.count<64)return s;!i&&e===null&&(e=s)}return e}findMainSlotFor(t){let e=null;for(let s=9;s<36;s++){const i=this.slots[s];if(i&&i.type===t&&i.count<64)return s;!i&&e===null&&(e=s)}return e}moveToHotbar(t){const e=this.slots[t];if(!e)return!1;const s=this.findHotbarSlotFor(e.type);if(s===null)return!1;const i=this.slots[s],o=Math.min(i?64-i.count:64,e.count);return o===0?!1:(i?i.count+=o:this.slots[s]={type:e.type,count:o},e.count-=o,e.count<=0&&(this.slots[t]=null),!0)}moveToMain(t){const e=this.slots[t];if(!e)return!1;const s=this.findMainSlotFor(e.type);if(s===null)return!1;const i=this.slots[s],o=Math.min(i?64-i.count:64,e.count);return o===0?!1:(i?i.count+=o:this.slots[s]={type:e.type,count:o},e.count-=o,e.count<=0&&(this.slots[t]=null),!0)}getSelectedBlock(){const t=this.slots[this.hotbarSlot];return t?t.type:0}getSelectedItem(){return this.slots[this.hotbarSlot]}damageTool(t=1){const e=this.slots[this.hotbarSlot];if(!e)return!1;const s=this.uiManager.getToolInfo(e.type);return s?(e.durability===void 0&&(e.durability=s.maxDurability),e.durability-=t,e.durability<=0?(this.slots[this.hotbarSlot]=null,this.uiManager.updateInventoryUI(),!0):(this.uiManager.updateInventoryUI(),!1)):!1}selectSlot(t){t>=0&&t<9&&(this.hotbarSlot=t,this.uiManager.updateHotbarSelection(t))}}const D={PICKAXE:"pickaxe",AXE:"axe",SHOVEL:"shovel",SWORD:"sword",ARMOR:"armor"},z={WOOD:{name:"wood",color:9268835},STONE:{name:"stone",color:10395294},IRON:{name:"iron",color:14737632},DIAMOND:{name:"diamond",color:5099745}},it={pickaxe:["MMMMM"," M M ","  S  ","  S  ","  S  ","  S  ","  S  ","  S  "],axe:[" MM","MMM","MS "," S "," S "," S "," S "," S "],shovel:[" M ","MMM","MMM"," S "," S "," S "," S "," S "],sword:[" M "," M "," M "," M "," M ","SMS"," S "," S "],helmet:["MMMMM","M   M","M   M","     ","     ","     ","     ","     "],chestplate:["M   M","MMMMM","MMMMM","MMMMM","MMMMM","     ","     ","     "],leggings:["MMMMM","MMMMM","M   M","M   M","M   M","     ","     ","     "],boots:["     ","     ","M   M","M   M","M   M","     ","     ","     "],bed:["WWWWW","WWWWW","SSSSS","S   S","     ","     ","     ","     "],chest:["SSSSS","S   S","S M S","S   S","SSSSS","     ","     ","     "],door:["SS","SM","SS","SM","SS","SM","SS","  "]},Pt={20:{type:D.PICKAXE,tier:z.WOOD,id:20},21:{type:D.AXE,tier:z.WOOD,id:21},22:{type:D.SHOVEL,tier:z.WOOD,id:22},23:{type:D.SWORD,tier:z.WOOD,id:23},24:{type:D.PICKAXE,tier:z.STONE,id:24},25:{type:D.AXE,tier:z.STONE,id:25},26:{type:D.SHOVEL,tier:z.STONE,id:26},27:{type:D.SWORD,tier:z.STONE,id:27},28:{type:D.PICKAXE,tier:z.IRON,id:28},29:{type:D.AXE,tier:z.IRON,id:29},30:{type:D.SHOVEL,tier:z.IRON,id:30},31:{type:D.SWORD,tier:z.IRON,id:31},32:{type:D.PICKAXE,tier:z.DIAMOND,id:32},33:{type:D.AXE,tier:z.DIAMOND,id:33},34:{type:D.SHOVEL,tier:z.DIAMOND,id:34},35:{type:D.SWORD,tier:z.DIAMOND,id:35},54:{type:D.ARMOR,part:"helmet",tier:z.IRON,id:54},55:{type:D.ARMOR,part:"chestplate",tier:z.IRON,id:55},56:{type:D.ARMOR,part:"leggings",tier:z.IRON,id:56},57:{type:D.ARMOR,part:"boots",tier:z.IRON,id:57},58:{type:D.ARMOR,part:"helmet",tier:z.DIAMOND,id:58},59:{type:D.ARMOR,part:"chestplate",tier:z.DIAMOND,id:59},60:{type:D.ARMOR,part:"leggings",tier:z.DIAMOND,id:60},61:{type:D.ARMOR,part:"boots",tier:z.DIAMOND,id:61},70:{type:"bed",id:70},71:{type:"chest",id:71},72:{type:"door",id:72}};class Be{constructor(t){this.inventory=t||null,this.hotbarEl=document.getElementById("hotbar"),this.inventoryHotbarEl=document.getElementById("inventory-hotbar"),this.inventoryGridEl=document.getElementById("inventory-grid"),this.blockTypes=[{id:1,name:"Ð—ÐµÐ¼Ð»Ñ",color:"#5d4037"},{id:2,name:"Ð¢Ñ€Ð°Ð²Ð°",color:"#4caf50"},{id:3,name:"ÐšÐ°Ð¼Ñ–Ð½ÑŒ",color:"#757575"},{id:4,name:"ÐšÐ¾Ð»Ð¾Ð´Ð°",color:"#6d4c41"},{id:5,name:"ÐŸÑ–ÑÐ¾Ðº",color:"#fff176"},{id:6,name:"Ð’Ð¾Ð´Ð°",color:"#42a5f5"},{id:7,name:"Ð›Ð¸ÑÑ‚Ñ",color:"#2e7d32"},{id:8,name:"Ð”Ð¾ÑˆÐºÐ°",color:"#a1887f"},{id:9,name:"ÐšÐ¾Ñ€Ñ–Ð½Ð½Ð° Ð¿Ð¾Ñ€Ð¾Ð´Ð°",color:"#212121"},{id:10,name:"ÐŸÐ°Ð»Ð¸Ñ†Ñ",color:"#ffd54f"},{id:11,name:"Ð¡Ð¸Ñ€Ðµ Ð¼'ÑÑÐ¾",color:"#ff7043"},{id:12,name:"Ð’Ð¾Ð²Ð½Ð°",color:"#f5f5f5"},{id:16,name:"Ð¡Ð¼Ð°Ð¶ÐµÐ½Ðµ Ð¼'ÑÑÐ¾",color:"#8b4513"},{id:17,name:"Ð¥Ð»Ñ–Ð±",color:"#daa520"},{id:18,name:"ÐŸÑˆÐµÐ½Ð¸Ñ†Ñ",color:"#f0e68c"},{id:13,name:"ÐŸÐµÑ€Ð¾",color:"#fff59d"},{id:14,name:"Ð¤Ð°ÐºÐµÐ»",color:"#ffe082"},{id:15,name:"Ð›Ð°Ð²Ð°",color:"#ff6d00"},{id:20,name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð° ÐºÑ–Ñ€ÐºÐ°",color:"#8d6e63"},{id:21,name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",color:"#8d6e63"},{id:22,name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",color:"#8d6e63"},{id:23,name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð¸Ð¹ Ð¼ÐµÑ‡",color:"#8d6e63"},{id:24,name:"ÐšÐ°Ð¼'ÑÐ½Ð° ÐºÑ–Ñ€ÐºÐ°",color:"#757575"},{id:25,name:"ÐšÐ°Ð¼'ÑÐ½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",color:"#757575"},{id:26,name:"ÐšÐ°Ð¼'ÑÐ½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",color:"#757575"},{id:27,name:"ÐšÐ°Ð¼'ÑÐ½Ð¸Ð¹ Ð¼ÐµÑ‡",color:"#757575"},{id:28,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° ÐºÑ–Ñ€ÐºÐ°",color:"#b0bec5"},{id:29,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",color:"#b0bec5"},{id:30,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",color:"#b0bec5"},{id:31,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ Ð¼ÐµÑ‡",color:"#b0bec5"},{id:32,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð° ÐºÑ–Ñ€ÐºÐ°",color:"#4dd0e1"},{id:33,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",color:"#4dd0e1"},{id:34,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",color:"#4dd0e1"},{id:35,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð¸Ð¹ Ð¼ÐµÑ‡",color:"#4dd0e1"},{id:40,name:"Ð’ÑƒÐ³Ñ–Ð»Ð»Ñ",color:"#263238"},{id:41,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° Ñ€ÑƒÐ´Ð°",color:"#d7ccc8"},{id:42,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ Ð·Ð»Ð¸Ñ‚Ð¾Ðº",color:"#eceff1"},{id:43,name:"ÐÐ»Ð¼Ð°Ð·",color:"#00bcd4"},{id:44,name:"Ð‘Ñ€ÑƒÐºÑ–Ð²ÐºÐ°",color:"#616161"},{id:54,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ ÑˆÐ¾Ð»Ð¾Ð¼",color:"#b0bec5"},{id:55,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ´Ð½Ð¸Ðº",color:"#b0bec5"},{id:56,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ñ– Ð¿Ð¾Ð½Ð¾Ð¶Ñ–",color:"#b0bec5"},{id:57,name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ñ– Ñ‡Ð¾Ð±Ð¾Ñ‚Ð¸",color:"#b0bec5"},{id:58,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð¸Ð¹ ÑˆÐ¾Ð»Ð¾Ð¼",color:"#4dd0e1"},{id:59,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð¸Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ´Ð½Ð¸Ðº",color:"#4dd0e1"},{id:60,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ñ– Ð¿Ð¾Ð½Ð¾Ð¶Ñ–",color:"#4dd0e1"},{id:61,name:"ÐÐ»Ð¼Ð°Ð·Ð½Ñ– Ñ‡Ð¾Ð±Ð¾Ñ‚Ð¸",color:"#4dd0e1"},{id:70,name:"Ð›Ñ–Ð¶ÐºÐ¾",color:"#ff5555"},{id:71,name:"Ð¡ÐºÑ€Ð¸Ð½Ñ",color:"#8b6914"},{id:72,name:"Ð”Ð²ÐµÑ€Ñ–",color:"#8d6e63"}],this.craftSlots=[null,null,null,null],this.craftResult=null,this.recipes=[{name:"Ð”Ð¾ÑˆÐºÐ¸",inputs:[{type:4,count:1}],result:{type:8,count:4}},{name:"ÐŸÐ°Ð»Ð¸Ñ†Ñ–",inputs:[{type:8,count:2}],result:{type:10,count:4}},{name:"Ð¤Ð°ÐºÐµÐ»",inputs:[{type:10,count:1},{type:40,count:1}],result:{type:14,count:4}},{name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð° ÐºÑ–Ñ€ÐºÐ°",inputs:[{type:8,count:3},{type:10,count:2}],result:{type:20,count:1}},{name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",inputs:[{type:8,count:3},{type:10,count:2}],result:{type:21,count:1}},{name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",inputs:[{type:8,count:1},{type:10,count:2}],result:{type:22,count:1}},{name:"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ð¸Ð¹ Ð¼ÐµÑ‡",inputs:[{type:8,count:2},{type:10,count:1}],result:{type:23,count:1}},{name:"ÐšÐ°Ð¼'ÑÐ½Ð° ÐºÑ–Ñ€ÐºÐ°",inputs:[{type:44,count:3},{type:10,count:2}],result:{type:24,count:1}},{name:"ÐšÐ°Ð¼'ÑÐ½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",inputs:[{type:44,count:3},{type:10,count:2}],result:{type:25,count:1}},{name:"ÐšÐ°Ð¼'ÑÐ½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",inputs:[{type:44,count:1},{type:10,count:2}],result:{type:26,count:1}},{name:"ÐšÐ°Ð¼'ÑÐ½Ð¸Ð¹ Ð¼ÐµÑ‡",inputs:[{type:44,count:2},{type:10,count:1}],result:{type:27,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° ÐºÑ–Ñ€ÐºÐ°",inputs:[{type:42,count:3},{type:10,count:2}],result:{type:28,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",inputs:[{type:42,count:3},{type:10,count:2}],result:{type:29,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",inputs:[{type:42,count:1},{type:10,count:2}],result:{type:30,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ Ð¼ÐµÑ‡",inputs:[{type:42,count:2},{type:10,count:1}],result:{type:31,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð° ÐºÑ–Ñ€ÐºÐ°",inputs:[{type:43,count:3},{type:10,count:2}],result:{type:32,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð° ÑÐ¾ÐºÐ¸Ñ€Ð°",inputs:[{type:43,count:3},{type:10,count:2}],result:{type:33,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð° Ð»Ð¾Ð¿Ð°Ñ‚Ð°",inputs:[{type:43,count:1},{type:10,count:2}],result:{type:34,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð¸Ð¹ Ð¼ÐµÑ‡",inputs:[{type:43,count:2},{type:10,count:1}],result:{type:35,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ ÑˆÐ¾Ð»Ð¾Ð¼",inputs:[{type:42,count:5}],result:{type:54,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ´Ð½Ð¸Ðº",inputs:[{type:42,count:8}],result:{type:55,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ñ– Ð¿Ð¾Ð½Ð¾Ð¶Ñ–",inputs:[{type:42,count:7}],result:{type:56,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ñ– Ñ‡Ð¾Ð±Ð¾Ñ‚Ð¸",inputs:[{type:42,count:4}],result:{type:57,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð¸Ð¹ ÑˆÐ¾Ð»Ð¾Ð¼",inputs:[{type:43,count:5}],result:{type:58,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ð¸Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ´Ð½Ð¸Ðº",inputs:[{type:43,count:8}],result:{type:59,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ñ– Ð¿Ð¾Ð½Ð¾Ð¶Ñ–",inputs:[{type:43,count:7}],result:{type:60,count:1}},{name:"ÐÐ»Ð¼Ð°Ð·Ð½Ñ– Ñ‡Ð¾Ð±Ð¾Ñ‚Ð¸",inputs:[{type:43,count:4}],result:{type:61,count:1}},{name:"Ð—Ð°Ð»Ñ–Ð·Ð½Ð¸Ð¹ Ð·Ð»Ð¸Ñ‚Ð¾Ðº",inputs:[{type:41,count:1},{type:40,count:1}],result:{type:42,count:1}},{name:"Ð¡Ð¼Ð°Ð¶ÐµÐ½Ðµ Ð¼'ÑÑÐ¾",inputs:[{type:11,count:1},{type:40,count:1}],result:{type:16,count:1}},{name:"Ð¥Ð»Ñ–Ð±",inputs:[{type:18,count:3}],result:{type:17,count:1}},{name:"Ð›Ñ–Ð¶ÐºÐ¾",inputs:[{type:8,count:3},{type:12,count:3}],result:{type:70,count:1}},{name:"Ð¡ÐºÑ€Ð¸Ð½Ñ",inputs:[{type:8,count:8}],result:{type:71,count:1}},{name:"Ð”Ð²ÐµÑ€Ñ–",inputs:[{type:8,count:6}],result:{type:72,count:1}}],this.initCraftingUI(),this.initRecipeGuide(),this.inventory&&this.setInventory(this.inventory)}initRecipeGuide(){const t=document.getElementById("recipe-guide-btn"),e=document.getElementById("recipe-guide-panel"),s=document.getElementById("recipe-guide-close");t&&(t.onclick=()=>{e.style.display="block",this.renderRecipeGuide()}),s&&(s.onclick=()=>{e.style.display="none"})}renderRecipeGuide(){const t=document.getElementById("recipe-guide-content");if(!t)return;t.innerHTML="";const e={Ð‘Ð°Ð·Ð¾Ð²Ðµ:this.recipes.slice(0,3),"Ð”ÐµÑ€ÐµÐ²'ÑÐ½Ñ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸":this.recipes.slice(3,7),"ÐšÐ°Ð¼'ÑÐ½Ñ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸":this.recipes.slice(7,11),"Ð—Ð°Ð»Ñ–Ð·Ð½Ñ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸":this.recipes.slice(11,15),"ÐÐ»Ð¼Ð°Ð·Ð½Ñ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸":this.recipes.slice(15,19),"Ð—Ð°Ð»Ñ–Ð·Ð½Ð° Ð±Ñ€Ð¾Ð½Ñ":this.recipes.slice(19,23),"ÐÐ»Ð¼Ð°Ð·Ð½Ð° Ð±Ñ€Ð¾Ð½Ñ":this.recipes.slice(23,27),"Ð¡Ð¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ñ– Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¸":this.recipes.slice(28,31),"Ð‡Ð¶Ð° Ñ‚Ð° Ð¿ÐµÑ€ÐµÐ¿Ð»Ð°Ð²ÐºÐ°":this.recipes.slice(27)};for(const[s,i]of Object.entries(e)){const o=document.createElement("div");o.className="recipe-category";const r=document.createElement("h4");r.textContent=s,o.appendChild(r);for(const a of i){const n=document.createElement("div");n.className="recipe-item";const c=document.createElement("div");c.className="recipe-inputs";for(const h of a.inputs){const u=document.createElement("div");u.className="recipe-slot",this.renderItem(u,h),c.appendChild(u)}n.appendChild(c);const l=document.createElement("div");l.className="recipe-arrow",l.textContent="â†’",n.appendChild(l);const d=document.createElement("div");d.className="recipe-slot",this.renderItem(d,a.result,!0),n.appendChild(d),o.appendChild(n)}t.appendChild(o)}}setInventory(t){this.inventory=t,this.initHotbar(),this.updateInventoryUI()}getBlockColor(t){const e=this.blockTypes.find(s=>s.id===t);return e?e.color:"#ff00ff"}getBlockName(t){const e=this.blockTypes.find(s=>s.id===t);return e?e.name:"Unknown"}initHotbar(){if(this.hotbarEl){this.hotbarEl.innerHTML="";for(let t=0;t<9;t++){const e=document.createElement("div");e.className="slot",e.dataset.index=t,t===0&&e.classList.add("active");const s=document.createElement("div");s.className="slot-content",e.appendChild(s),e.onclick=()=>{this.inventory&&this.inventory.selectSlot(t)},this.hotbarEl.appendChild(e)}}}updateHotbarSelection(t){if(!this.hotbarEl)return;const e=this.hotbarEl.querySelectorAll(".slot");e.forEach(s=>s.classList.remove("active")),e[t]&&e[t].classList.add("active")}initCraftingUI(){document.querySelectorAll(".crafting-slot").forEach((e,s)=>{e.dataset.craftIndex=s})}updateInventoryUI(){if(!this.inventory)return;const t=this.hotbarEl.querySelectorAll(".slot");for(let e=0;e<9;e++){const s=this.inventory.slots[e],i=t[e].querySelector(".slot-content");i&&(i.innerHTML="",s&&this.renderItem(i,s))}if(this.inventoryHotbarEl){this.inventoryHotbarEl.innerHTML="";for(let e=0;e<9;e++){const s=this.inventory.slots[e],i=document.createElement("div");i.className="inv-slot",i.addEventListener("click",o=>this.handleSlotClick(e,o)),s&&this.renderItem(i,s),this.inventoryHotbarEl.appendChild(i)}}if(this.inventoryGridEl){this.inventoryGridEl.innerHTML="";for(let e=9;e<36;e++){const s=this.inventory.slots[e],i=document.createElement("div");i.className="inv-slot",i.addEventListener("click",o=>this.handleSlotClick(e,o)),s&&this.renderItem(i,s),this.inventoryGridEl.appendChild(i)}}this.checkRecipes(),this.updateCraftingUI()}renderItem(t,e,s=!1){t.innerHTML="",t.style.position="relative";const i=Pt[e.type];if(i){const n=document.createElement("canvas");n.width=32,n.height=32,n.style.width="24px",n.style.height="24px",n.style.margin="auto",n.style.imageRendering="pixelated";const c=n.getContext("2d");let l,d;if(i.type==="armor"?(l=it[i.part],d={S:"#6d4c41",M:"#"+i.tier.color.toString(16).padStart(6,"0")}):i.type==="bed"?(l=it.bed,d={W:"#ff5555",S:"#8d6e63"}):i.type==="chest"?(l=it.chest,d={S:"#8b6914",M:"#4a4a4a"}):i.type==="door"?(l=it.door,d={S:"#8d6e63",M:"#4a4a4a"}):(l=it[i.type],d={S:"#6d4c41",M:"#"+i.tier.color.toString(16).padStart(6,"0")}),l)for(let u=0;u<l.length;u++)for(let p=0;p<l[u].length;p++){const f=l[u][p];f!==" "&&d[f]&&(c.fillStyle=d[f],c.fillRect(p*4,u*4,4,4))}t.appendChild(n)}else{const n=document.createElement("div");n.style.width="20px",n.style.height="20px",n.style.backgroundColor=this.getBlockColor(e.type),n.style.margin="auto",n.style.borderRadius="3px",n.style.border="2px solid rgba(0,0,0,0.1)",n.style.borderTop="2px solid rgba(255,255,255,0.2)",n.style.borderLeft="2px solid rgba(255,255,255,0.2)",t.appendChild(n)}const o=document.createElement("div");o.innerText=e.count||1,o.style.fontSize="10px",o.style.position="absolute",o.style.bottom="0",o.style.right="0",o.style.color="white",o.style.fontWeight="bold",o.style.textShadow="1px 1px 0 #000";const r=this.getToolInfo(e.type);let a=this.getBlockName(e.type);if(r&&e.durability!==void 0){o.innerText=`${e.durability}/${r.maxDurability}`,o.style.fontSize="8px",a+=` (${e.durability}/${r.maxDurability})`;const n=document.createElement("div");n.style.position="absolute",n.style.bottom="-2px",n.style.left="2px",n.style.right="2px",n.style.height="2px",n.style.backgroundColor="#333";const c=document.createElement("div"),l=e.durability/r.maxDurability;c.style.width=`${l*100}%`,c.style.height="100%",c.style.backgroundColor=l>.5?"#4caf50":l>.2?"#ff9800":"#f44336",n.appendChild(c),t.appendChild(n)}if(t.title=a,t.dataset.itemType=e.type,(!r||e.count>1)&&t.appendChild(o),s){const n=document.createElement("div");n.style.position="absolute",n.style.bottom="-18px",n.style.left="-10px",n.style.right="-10px",n.style.fontSize="10px",n.style.color="#fff",n.style.textAlign="center",n.style.textShadow="1px 1px 2px #000",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.textOverflow="ellipsis",n.innerText=this.getBlockName(e.type),t.appendChild(n)}}getToolInfo(t){return{20:{type:"pickaxe",tier:"wood",speed:2,maxDurability:60},21:{type:"axe",tier:"wood",speed:2,maxDurability:60},22:{type:"shovel",tier:"wood",speed:2,maxDurability:60},23:{type:"sword",tier:"wood",speed:1.5,maxDurability:60},24:{type:"pickaxe",tier:"stone",speed:4,maxDurability:132},25:{type:"axe",tier:"stone",speed:4,maxDurability:132},26:{type:"shovel",tier:"stone",speed:4,maxDurability:132},27:{type:"sword",tier:"stone",speed:3,maxDurability:132},28:{type:"pickaxe",tier:"iron",speed:6,maxDurability:251},29:{type:"axe",tier:"iron",speed:6,maxDurability:251},30:{type:"shovel",tier:"iron",speed:6,maxDurability:251},31:{type:"sword",tier:"iron",speed:4,maxDurability:251},32:{type:"pickaxe",tier:"diamond",speed:8,maxDurability:1562},33:{type:"axe",tier:"diamond",speed:8,maxDurability:1562},34:{type:"shovel",tier:"diamond",speed:8,maxDurability:1562},35:{type:"sword",tier:"diamond",speed:6,maxDurability:1562},54:{type:"armor",part:"helmet",tier:"iron",maxDurability:165},55:{type:"armor",part:"chestplate",tier:"iron",maxDurability:240},56:{type:"armor",part:"leggings",tier:"iron",maxDurability:225},57:{type:"armor",part:"boots",tier:"iron",maxDurability:195},58:{type:"armor",part:"helmet",tier:"diamond",maxDurability:363},59:{type:"armor",part:"chestplate",tier:"diamond",maxDurability:528},60:{type:"armor",part:"leggings",tier:"diamond",maxDurability:495},61:{type:"armor",part:"boots",tier:"diamond",maxDurability:429}}[t]||null}handleSlotClick(t,e){if(this.inventory.slots[t]){if(e&&e.shiftKey){(t>=9?this.inventory.moveToHotbar(t):this.inventory.moveToMain(t))&&this.updateInventoryUI();return}this.moveToCrafting(t)}}moveToCrafting(t){const e=this.inventory.slots[t];if(!e)return;let s=-1;for(let o=0;o<this.craftSlots.length;o++)if(this.craftSlots[o]&&this.craftSlots[o].type===e.type){s=o;break}s===-1&&(s=this.findEmptyCraftSlot()),!(s===-1||!this.inventory.consumeSlot(t))&&(this.craftSlots[s]?this.craftSlots[s].count+=1:this.craftSlots[s]={type:e.type,count:1},this.checkRecipes(),this.updateInventoryUI())}findCraftSlotFor(t){return-1}findEmptyCraftSlot(){for(let t=0;t<this.craftSlots.length;t++)if(!this.craftSlots[t])return t;return-1}returnCraftingSlot(t){const e=this.craftSlots[t];!e||!this.inventory.add(e.type,e.count,{skipUI:!0})||(this.craftSlots[t]=null,this.checkRecipes(),this.updateInventoryUI())}checkRecipes(){this.craftResult=null;for(const t of this.recipes)if(this.matchesRecipe(t)){this.craftResult=t;return}}matchesRecipe(t){const e={};let s=0;for(const o of this.craftSlots)o&&(e[o.type]=(e[o.type]||0)+o.count,s+=o.count);let i=0;for(const o of t.inputs)if(i+=o.count,(e[o.type]||0)<o.count)return!1;if(s!==i)return!1;for(const o in e){const r=t.inputs.find(a=>a.type===parseInt(o));if(!r||e[o]!==r.count)return!1}return!0}completeCraft(){if(!this.craftResult)return;const{type:t,count:e}=this.craftResult.result;if(!this.inventory.canAdd(t,e))return;for(const i of this.craftResult.inputs){let o=i.count;for(let r=0;r<this.craftSlots.length&&o>0;r++){const a=this.craftSlots[r];if(a&&a.type===i.type){const n=Math.min(a.count,o);a.count-=n,o-=n,a.count===0&&(this.craftSlots[r]=null)}}}const s=this.getToolInfo(t);s?this.inventory.add(t,e,{skipUI:!0,durability:s.maxDurability}):this.inventory.add(t,e,{skipUI:!0}),this.checkRecipes(),this.updateInventoryUI()}updateCraftingUI(){document.querySelectorAll("#crafting-panel .crafting-slot").forEach((i,o)=>{i.innerHTML="";const r=this.craftSlots[o];r&&this.renderItem(i,r),i.onclick=()=>this.returnCraftingSlot(o)});const e=document.getElementById("crafting-result"),s=document.getElementById("crafting-result-name");s&&(s.innerText=this.craftResult?this.craftResult.name:"Ð ÐµÑ†ÐµÐ¿Ñ‚ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"),e&&(e.innerHTML="",this.craftResult?(this.renderItem(e,this.craftResult.result),e.onclick=()=>this.completeCraft(),e.style.cursor="pointer",e.title=`Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ ${this.craftResult.name}`):(e.onclick=null,e.style.cursor="default",e.title=""))}}class Le{constructor(t){this.scene=t,this.group=new tt,this.scene.add(this.group),this.clouds=[],this.radius=120,this.baseY=85,this.speed=3;const e=new j({color:16777215,transparent:!0,opacity:.85,depthWrite:!1}),s=()=>{const i=new tt,o=new T(6,3,4),r=3+Math.floor(Math.random()*4);for(let a=0;a<r;a++){const n=new S(o,e);n.position.set((Math.random()-.5)*10,(Math.random()-.5)*2,(Math.random()-.5)*8),n.scale.set(.8+Math.random()*1.4,.8+Math.random()*1.1,.8+Math.random()*1.4),i.add(n)}return i};for(let i=0;i<18;i++){const o=s();o.position.set((Math.random()-.5)*this.radius*2,this.baseY+Math.random()*18,(Math.random()-.5)*this.radius*2),o.userData.vx=(.3+Math.random()*.7)*(Math.random()<.5?1:-1),o.userData.vz=(.2+Math.random()*.6)*(Math.random()<.5?1:-1),this.group.add(o),this.clouds.push(o)}}update(t,e){if(!t)return;const s=e?.x??0,i=e?.z??0;for(const o of this.clouds){o.position.x+=o.userData.vx*this.speed*t,o.position.z+=o.userData.vz*this.speed*t;const r=o.position.x-s,a=o.position.z-i;r>this.radius&&(o.position.x-=this.radius*2),r<-this.radius&&(o.position.x+=this.radius*2),a>this.radius&&(o.position.z-=this.radius*2),a<-this.radius&&(o.position.z+=this.radius*2)}}}class Oe{constructor(t,e){this.scene=t,this.camera=e,this.handGroup=new tt,this.currentTool=null,this.currentToolType=null,this.animationTime=0,this.swingTime=0,this.isSwinging=!1,this.createHand(),this.handGroup.position.set(.25,-.25,-.4),this.handGroup.rotation.set(0,-.1,0),this.camera.add(this.handGroup)}createVoxelMesh(t,e,s=1){const i=new tt,o=.02,r=t.length,a=t[0].length,n=-(a*o)/2,c=-(r*o)/2,l=-(s*o)/2,d=new T(o,o,o);for(let h=0;h<r;h++)for(let u=0;u<a;u++){const p=t[h][u];if(p!==" "&&e[p]){const f=new j({color:e[p]});for(let m=0;m<s;m++){const g=new S(d,f);g.position.set(n+u*o,-c-h*o,l+m*o),g.castShadow=!0,g.receiveShadow=!0,i.add(g)}}}return i}createHand(){this.handGroup.clear();const t=new T(.08,.24,.08),e=new j({color:16032864}),s=new S(t,e);s.position.set(0,-.12,0),this.handGroup.add(s),this.arm=s}setTool(t){if(this.currentToolType===t||(this.currentTool&&(this.handGroup.remove(this.currentTool),this.currentTool=null),this.currentToolType=t,!t))return;const e=Pt[t];e&&(this.currentTool=this.createToolMesh(e),this.currentTool&&(this.currentTool.scale.set(1.5,1.5,1.5),this.currentTool.position.set(0,.1,-.15),this.currentTool.rotation.set(0,Math.PI/2,0),this.handGroup.add(this.currentTool)))}getToolInfo(t){return Pt[t]||null}createToolMesh(t){if(!t)return null;const e={S:7162945,M:t.tier?t.tier.color:16777215};let s=null;if(t.type==="armor"?s=it[t.part]:s=it[t.type],!s)return null;const i=s.map(o=>o.split(""));return this.createVoxelMesh(i,e,1)}startSwing(){this.isSwinging=!0,this.swingTime=0}update(t,e){const s=e?e.type:null,i=e?this.getToolInfo(e.type):null;this.setTool(i?s:null),this.animationTime+=t;const o=Math.sin(this.animationTime*2.5)*.008,r=Math.sin(this.animationTime*1.8)*.015;if(this.isSwinging){this.swingTime+=t*10,this.swingTime>=Math.PI&&(this.isSwinging=!1,this.swingTime=0);const a=Math.sin(this.swingTime);this.handGroup.rotation.x=-a*1.2,this.handGroup.rotation.y=-.5+a*.5,this.handGroup.position.z=-.6-a*.3,this.handGroup.position.y=-.25-a*.1}else this.handGroup.rotation.x=st.lerp(this.handGroup.rotation.x,o*.5,.1),this.handGroup.rotation.y=st.lerp(this.handGroup.rotation.y,-.3+r*.5,.1),this.handGroup.rotation.z=st.lerp(this.handGroup.rotation.z,r*.2,.1),this.handGroup.position.y=st.lerp(this.handGroup.position.y,-.25+o,.1),this.handGroup.position.x=st.lerp(this.handGroup.position.x,.35+r,.1),this.handGroup.position.z=st.lerp(this.handGroup.position.z,-.6,.1)}}class Ae{constructor(t){this.scene=t,this.dayLength=600,this.currentTime=0,this.sunLight=null,this.moonLight=null,this.ambientLight=null,this.skyColors={day:new R(8900331),sunset:new R(16739125),night:new R(657946),sunrise:new R(16751983)},this.fogColors={day:new R(8900331),sunset:new R(13391155),night:new R(657946),sunrise:new R(14513988)},this.setupLights(),this.createSunMoon()}setupLights(){const t=[];this.scene.traverse(e=>{e.isLight&&t.push(e)}),t.forEach(e=>this.scene.remove(e)),this.ambientLight=new fe(16777215,.6),this.scene.add(this.ambientLight),this.sunLight=new Ht(16777215,.8),this.sunLight.position.set(50,100,50),this.sunLight.castShadow=!0,this.sunLight.shadow.mapSize.width=2048,this.sunLight.shadow.mapSize.height=2048,this.sunLight.shadow.camera.near=.5,this.sunLight.shadow.camera.far=500,this.sunLight.shadow.camera.left=-50,this.sunLight.shadow.camera.right=50,this.sunLight.shadow.camera.top=50,this.sunLight.shadow.camera.bottom=-50,this.scene.add(this.sunLight),this.moonLight=new Ht(6711039,.2),this.moonLight.position.set(-50,100,-50),this.moonLight.visible=!1,this.scene.add(this.moonLight)}createSunMoon(){const t=new Ut(5,16,16),e=new Nt({color:16776960});this.sun=new S(t,e),this.scene.add(this.sun);const s=new Ut(4,16,16),i=new Nt({color:14540287});this.moon=new S(s,i),this.moon.visible=!1,this.scene.add(this.moon)}update(t,e){this.currentTime+=t/this.dayLength,this.currentTime>=1&&(this.currentTime-=1);const s=this.getTimeOfDay();this.updateSkyColor(),this.updateLighting(s),this.updateCelestialBodies(e)}getTimeOfDay(){return this.currentTime<.23?"night":this.currentTime<.27?"sunrise":this.currentTime<.73?"day":this.currentTime<.77?"sunset":"night"}updateSkyColor(){let t,e;if(this.currentTime<.23)t=this.skyColors.night,e=this.fogColors.night;else if(this.currentTime<.27){const s=(this.currentTime-.23)/.04;t=new R().lerpColors(this.skyColors.night,this.skyColors.sunrise,s),e=new R().lerpColors(this.fogColors.night,this.fogColors.sunrise,s)}else if(this.currentTime<.73){const s=Math.min((this.currentTime-.27)/.1,1);t=new R().lerpColors(this.skyColors.sunrise,this.skyColors.day,s),e=new R().lerpColors(this.fogColors.sunrise,this.fogColors.day,s)}else if(this.currentTime<.77){const s=(this.currentTime-.73)/.04;t=new R().lerpColors(this.skyColors.day,this.skyColors.sunset,s),e=new R().lerpColors(this.fogColors.day,this.fogColors.sunset,s)}else{const s=Math.min((this.currentTime-.77)/.1,1);t=new R().lerpColors(this.skyColors.sunset,this.skyColors.night,s),e=new R().lerpColors(this.fogColors.sunset,this.fogColors.night,s)}this.scene.background=t,this.scene.fog&&(this.scene.fog.color=e)}updateLighting(t){const e=t==="night";let s,i;if(this.currentTime<.25)s=.3,i=0;else if(this.currentTime<.3){const o=(this.currentTime-.25)/.05;s=.3+o*.3,i=o*.8}else if(this.currentTime<.7)s=.6,i=.8;else if(this.currentTime<.75){const o=(this.currentTime-.7)/.05;s=.6-o*.3,i=.8-o*.8}else s=.3,i=0;this.ambientLight.intensity=s,this.sunLight.intensity=i,this.moonLight.intensity=e?.2:0,this.moonLight.visible=e,t==="sunrise"||t==="sunset"?this.sunLight.color.setHex(16755302):this.sunLight.color.setHex(16777215)}updateCelestialBodies(t){const e=this.currentTime*Math.PI*2,s=150,i=100,o=t.x+Math.cos(e)*s,r=Math.sin(e)*i,a=t.z+Math.sin(e)*s;this.sun.position.set(o,Math.max(r,-50),a),this.sun.visible=r>-20,this.sunLight.position.set(o,Math.max(r,50),a);const n=e+Math.PI,c=t.x+Math.cos(n)*s,l=Math.sin(n)*i,d=t.z+Math.sin(n)*s;this.moon.position.set(c,Math.max(l,-50),d),this.moon.visible=l>-20,this.moonLight.position.set(c,Math.max(l,50),d)}isNight(){return this.currentTime<.25||this.currentTime>.75}isDark(){return this.currentTime<.25||this.currentTime>.73}getTimeString(){const t=Math.floor(this.currentTime*24),e=Math.floor(this.currentTime*24*60%60);return`${t.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}setTime(t){this.currentTime=t%1}skipToMorning(){this.currentTime=.25}}class Re{constructor(t,e,s){this.scene=t,this.physicsWorld=e,this.world=s,this.monsters=[],this.maxMonsters=15,this.spawnRadius=25,this.minSpawnDistance=10,this.spawnTimer=0,this.spawnInterval=2,this.monsterMaterial=new vt("monster"),this.blockMaterial=new vt("block"),this.physicsWorld.addContactMaterial(new Zt(this.monsterMaterial,this.blockMaterial,{friction:.3,restitution:0})),this.monsterTypes={zombie:{name:"Ð—Ð¾Ð¼Ð±Ñ–",health:20,damage:3,speed:2.5,color:4022310,headColor:5074998,drop:{type:11,count:1}},skeleton:{name:"Ð¡ÐºÐµÐ»ÐµÑ‚",health:15,damage:2,speed:3,color:14540253,headColor:16777215,drop:{type:13,count:2}},creeper:{name:"ÐšÑ€Ñ–Ð¿ÐµÑ€",health:20,damage:25,speed:2.5,color:1025807,headColor:1025807,explodes:!0,drop:{type:40,count:1}}}}spawnMonster(t,e){const s=this.monsterTypes[t];if(!s)return null;const i=new tt,o=new T(.6,1.2,.3),r=new j({color:s.color}),a=new S(o,r);a.position.y=.6,a.castShadow=!0,i.add(a);const n=new T(.5,.5,.5),c=new j({color:s.headColor}),l=new S(n,c);l.position.y=1.45,l.castShadow=!0,i.add(l);const d=new T(.12,.12,.05);let h=16711680;(t==="creeper"||t==="skeleton")&&(h=0);const u=new Nt({color:h}),p=new S(d,u);p.position.set(-.15,1.55,.26),i.add(p);const f=new S(d,u);f.position.set(.15,1.55,.26),i.add(f);const m=new T(.3,.8,.3),g=new S(m,r);g.position.set(-.45,.8,0),g.castShadow=!0,i.add(g);const M=new S(m,r);M.position.set(.45,.8,0),M.castShadow=!0,i.add(M);const v=new T(.3,.8,.3),w=new S(v,r);w.position.set(-.15,0,0),w.castShadow=!0,i.add(w);const x=new S(v,r);x.position.set(.15,0,0),x.castShadow=!0,i.add(x),i.position.copy(e),this.scene.add(i);const L=new gt(new W(.3,.9,.15)),A=new ot({mass:80,position:new W(e.x,e.y+.9,e.z),shape:L,linearDamping:.9,angularDamping:.99,fixedRotation:!0,material:this.monsterMaterial});this.physicsWorld.addBody(A);const I={type:t,profile:s,mesh:i,body:A,health:s.health,maxHealth:s.health,target:null,attackCooldown:0,explodeTimer:-1,animationTime:Math.random()*Math.PI*2,bodyParts:{body:a,head:l,leftArm:g,rightArm:M,leftLeg:w,rightLeg:x},colliderMap:new Map};return this.monsters.push(I),I}update(t,e,s){s&&s.isDark()&&(this.spawnTimer+=t,this.spawnTimer>=this.spawnInterval&&this.monsters.length<this.maxMonsters&&(this.trySpawnMonster(e),this.spawnTimer=0));for(let i=this.monsters.length-1;i>=0;i--){const o=this.monsters[i];if(o.health<=0){this.removeMonster(i);continue}if(o.body.position.y<-50){this.removeMonster(i);continue}if(this.updateMonsterColliders(o),this.updateMonsterAI(o,e,t),o.mesh.position.set(o.body.position.x,o.body.position.y-.9,o.body.position.z),this.updateMonsterAnimation(o,t),o.target){const r=new F(e.body.position.x-o.body.position.x,0,e.body.position.z-o.body.position.z),a=Math.atan2(r.x,r.z);o.mesh.rotation.y=a}}}trySpawnMonster(t){for(let e=0;e<10;e++){const s=Math.random()*Math.PI*2,i=this.minSpawnDistance+Math.random()*(this.spawnRadius-this.minSpawnDistance),o=t.body.position.x+Math.cos(s)*i,r=t.body.position.z+Math.sin(s)*i;let a=null;for(let d=Math.floor(t.body.position.y)+20;d>=Math.floor(t.body.position.y)-10;d--){const h=this.world.getBlock(Math.floor(o),d,Math.floor(r)),u=this.world.getBlock(Math.floor(o),d+1,Math.floor(r)),p=this.world.getBlock(Math.floor(o),d+2,Math.floor(r));if(h!==0&&h!==6&&h!==15&&u===0&&p===0){a=d;break}}if(a===null)continue;const n=this.world.getBlock(Math.floor(o),a,Math.floor(r));if(n===6||n===15||Math.abs(a-t.body.position.y)>15)continue;const c=Object.keys(this.monsterTypes),l=c[Math.floor(Math.random()*c.length)];this.spawnMonster(l,new F(o,a+1.5,r)),console.log(`âœ… Ð—Ð°ÑÐ¿Ð°Ð²Ð½ÐµÐ½Ð¾ ${l} Ð½Ð° (${Math.floor(o)}, ${a}, ${Math.floor(r)}) - Ð²Ñ–Ð´ÑÑ‚Ð°Ð½ÑŒ Ð²Ñ–Ð´ Ð³Ñ€Ð°Ð²Ñ†Ñ: ${i.toFixed(1)}`);return}console.log("âŒ ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð·Ð½Ð°Ð¹Ñ‚Ð¸ Ð¼Ñ–ÑÑ†Ðµ Ð´Ð»Ñ ÑÐ¿Ð°Ð²Ð½Ñƒ Ð¼Ð¾Ð½ÑÑ‚Ñ€Ð°")}updateMonsterAI(t,e,s){const i=new F(e.body.position.x-t.body.position.x,e.body.position.y-t.body.position.y,e.body.position.z-t.body.position.z),o=Math.sqrt(i.x*i.x+i.z*i.z);if(o<30){if(t.target=e,t.profile.explodes&&o<3)if(t.explodeTimer<0)t.explodeTimer=1.5;else{t.explodeTimer-=s;const r=Math.sin(t.explodeTimer*20)>0;if(t.bodyParts.body.material.color.setHex(r?16777215:t.profile.color),t.explodeTimer<=0){this.explodeCreeper(t,e);return}}else t.explodeTimer=-1;if(o>2){i.normalize();const r=new W(i.x*t.profile.speed,t.body.velocity.y,i.z*t.profile.speed);t.body.velocity.x=r.x,t.body.velocity.z=r.z}else t.attackCooldown-=s,t.attackCooldown<=0&&(this.attackPlayer(t,e),t.attackCooldown=1.5)}else t.target=null,t.body.velocity.x*=.9,t.body.velocity.z*=.9}updateMonsterAnimation(t,e){if(t.animationTime+=e*3,Math.abs(t.body.velocity.x)>.1||Math.abs(t.body.velocity.z)>.1){const i=Math.sin(t.animationTime)*.5;t.bodyParts.leftArm.rotation.x=i,t.bodyParts.rightArm.rotation.x=-i,t.bodyParts.leftLeg.rotation.x=-i,t.bodyParts.rightLeg.rotation.x=i}else t.bodyParts.leftArm.rotation.x*=.9,t.bodyParts.rightArm.rotation.x*=.9,t.bodyParts.leftLeg.rotation.x*=.9,t.bodyParts.rightLeg.rotation.x*=.9}attackPlayer(t,e){if(!e.takeDamage)return;e.takeDamage(t.profile.damage);const s=new F(e.body.position.x-t.body.position.x,.5,e.body.position.z-t.body.position.z).normalize();e.body.velocity.x+=s.x*5,e.body.velocity.y+=s.y*5,e.body.velocity.z+=s.z*5}explodeCreeper(t,e){const s=Math.sqrt(Math.pow(e.body.position.x-t.body.position.x,2)+Math.pow(e.body.position.z-t.body.position.z,2));if(s<5){const n=t.profile.damage*(1-s/5);e.takeDamage&&e.takeDamage(n)}const i=Math.floor(t.body.position.x),o=Math.floor(t.body.position.y),r=Math.floor(t.body.position.z);for(let n=-2;n<=2;n++)for(let c=-2;c<=2;c++)for(let l=-2;l<=2;l++)Math.sqrt(n*n+c*c+l*l)<=2&&Math.random()>.3&&this.world.setBlock(i+n,o+c,r+l,0);const a=this.monsters.indexOf(t);a!==-1&&this.removeMonster(a)}damageMonster(t,e){t.health-=e;const s=t.profile.color;t.bodyParts.body.material.color.setHex(16711680),setTimeout(()=>{t.bodyParts.body&&t.bodyParts.body.material.color.setHex(s)},100)}removeMonster(t){const e=this.monsters[t];if(e.profile.drop&&e.health<=0&&(e.dropPosition=new F().copy(e.mesh.position)),e.colliderMap){for(const[s,i]of e.colliderMap)this.physicsWorld.removeBody(i);e.colliderMap.clear()}this.scene.remove(e.mesh),this.physicsWorld.removeBody(e.body),this.monsters.splice(t,1)}raycastMonster(t){for(const e of this.monsters)if(t.intersectObject(e.mesh,!0).length>0)return e;return null}clearAllMonsters(){for(;this.monsters.length>0;)this.removeMonster(0)}updateMonsterColliders(t){const s=Math.floor(t.body.position.x),i=Math.floor(t.body.position.y),o=Math.floor(t.body.position.z),r=new Set;for(let a=s-2;a<=s+2;a++)for(let n=i-2;n<=i+2;n++)for(let c=o-2;c<=o+2;c++){const l=this.world.getBlock(a,n,c);if(l!==0&&l!==6&&l!==7&&l!==15){const d=`${a},${n},${c}`;if(r.add(d),!t.colliderMap.has(d)){const h=new ot({mass:0,position:new W(a+.5,n+.5,c+.5),shape:new gt(new W(.5,.5,.5)),material:this.blockMaterial});this.physicsWorld.addBody(h),t.colliderMap.set(d,h)}}}for(const[a,n]of t.colliderMap)r.has(a)||(this.physicsWorld.removeBody(n),t.colliderMap.delete(a))}}class He{constructor(t,e,s){this.scene=t,this.world=e,this.physicsWorld=s,this.objects=new Map}clearAll(){const t=Array.from(this.objects.keys());for(const e of t){const s=this.objects.get(e);if(s){if(s.type==="door_top"){this.objects.delete(e);continue}this.removeObject(s.position?.x??parseInt(e.split(",")[0],10),s.position?.y??parseInt(e.split(",")[1],10),s.position?.z??parseInt(e.split(",")[2],10))}}this.objects.clear()}exportState(){const t=[];for(const[,e]of this.objects)!e||e.type==="door_top"||t.push({type:e.type,position:e.position,rotation:e.rotation??0,data:e.data??{}});return t}importState(t){if(this.clearAll(),!!Array.isArray(t))for(const e of t){if(!e||typeof e!="object")continue;const{type:s,position:i,rotation:o,data:r}=e;if(!i||!this.placeObject(s,i.x,i.y,i.z,o??0))continue;const n=this.getObject(i.x,i.y,i.z);n&&n.data&&r&&(n.data=structuredClone?structuredClone(r):JSON.parse(JSON.stringify(r)),n.type===72&&n.data.isOpen&&(n.physicsBody&&this.physicsWorld.removeBody(n.physicsBody),n.mesh?.userData?.door&&(n.mesh.userData.door.rotation.y=-Math.PI/2)))}}placeObject(t,e,s,i,o=0){const r=`${e},${s},${i}`;if(t===72){if(this.world.getBlock(e,s,i)!==0||this.world.getBlock(e,s+1,i)!==0||this.objects.has(r)||this.objects.has(`${e},${s+1},${i}`))return!1}else this.objects.has(r)&&this.removeObject(e,s,i);let a,n={type:t,position:{x:e,y:s,z:i},rotation:o,data:{}};if(t===70?(a=this.createBed(),n.data.sleepable=!0):t===71?(a=this.createChest(),n.data.inventory=new Array(27).fill(null)):t===72&&(a=this.createDoor(),n.data.isOpen=!1,n.data.multiBlock=!0,n.data.topBlock=`${e},${s+1},${i}`),a){if(a.position.set(e+.5,s,i+.5),a.rotation.y=o,a.castShadow=!0,a.receiveShadow=!0,this.scene.add(a),n.mesh=a,t===72){let c=0,l=0;const d=o%(Math.PI*2);Math.abs(d)<.1?l=.4:Math.abs(d-Math.PI/2)<.1?c=-.4:Math.abs(d-Math.PI)<.1?l=-.4:c=.4;const h=new ot({mass:0,position:new W(e+.5+c,s+1,i+.5+l),shape:new gt(new W(.45,1,.1))});h.quaternion.setFromEuler(0,o,0),this.physicsWorld.addBody(h),n.physicsBody=h,this.objects.set(n.data.topBlock,{type:"door_top",bottomBlock:r,mesh:a})}return this.objects.set(r,n),!0}return!1}createBed(){const t=new tt,e=new T(1,.2,2),s=new j({color:9268835}),i=new S(e,s);i.position.y=.4,t.add(i);const o=new T(.9,.3,1.9),r=new j({color:16733525}),a=new S(o,r);a.position.y=.65,t.add(a);const n=new T(.7,.15,.5),c=new j({color:16777215}),l=new S(n,c);l.position.set(0,.875,-.65),t.add(l);const d=new T(.1,.3,.1),h=new j({color:7162945});return[[-.4,.15,-.9],[.4,.15,-.9],[-.4,.15,.9],[.4,.15,.9]].forEach(p=>{const f=new S(d,h);f.position.set(...p),t.add(f)}),t}createChest(){const t=new tt,e=new T(.875,.875,.875),s=new j({color:9136404}),i=new S(e,s);i.position.y=.4375,t.add(i);const o=new T(.875,.25,.875),r=new j({color:10910747}),a=new S(o,r);a.position.y=1,a.position.z=0,a.geometry.translate(0,0,-.4375),t.add(a);const n=new T(.15,.15,.05),c=new j({color:4868682}),l=new S(n,c);return l.position.set(0,.5,.45),t.add(l),t.userData.lid=a,t.userData.lock=l,t}createDoor(){const t=new tt,e=new T(.875,1.875,.1875),s=new j({color:9268835}),i=new S(e,s);i.geometry.translate(.4375,0,0),i.position.set(-.4375,.9375,0),t.add(i);const o=new T(.08,1.9,.05),r=new j({color:7162945}),a=new S(o,r);a.position.set(.05,0,0),i.add(a);const n=new S(o,r);n.position.set(.825,0,0),i.add(n);const c=new T(.08,.15,.1),l=new j({color:8947848}),d=new S(c,l);return d.position.set(.75,0,.12),i.add(d),t.userData.door=i,t}toggleDoor(t,e,s){const i=`${t},${e},${s}`,o=this.objects.get(i);if(o&&o.type===72){o.data.isOpen=!o.data.isOpen,o.physicsBody&&(o.data.isOpen?this.physicsWorld.removeBody(o.physicsBody):this.physicsWorld.addBody(o.physicsBody));const r=o.data.isOpen?-Math.PI/2:0,a=()=>{const n=o.mesh.userData.door.rotation.y,c=r-n;Math.abs(c)>.01?(o.mesh.userData.door.rotation.y+=c*.2,requestAnimationFrame(a)):o.mesh.userData.door.rotation.y=r};return a(),!0}return!1}getObject(t,e,s){const i=`${t},${e},${s}`;return this.objects.get(i)}removeObject(t,e,s){const i=`${t},${e},${s}`,o=this.objects.get(i);if(o){if(o.type==="door_top"){const r=o.bottomBlock,a=this.objects.get(r);if(a)return this.removeObject(a.position.x,a.position.y,a.position.z)}return o.data&&o.data.topBlock&&this.objects.delete(o.data.topBlock),o.mesh&&o.type!=="door_top"&&(this.scene.remove(o.mesh),o.mesh.traverse(r=>{r.geometry&&r.geometry.dispose(),r.material&&(Array.isArray(r.material)?r.material.forEach(a=>a.dispose()):r.material.dispose())})),o.physicsBody&&this.physicsWorld.removeBody(o.physicsBody),this.objects.delete(i),!0}return!1}raycastObject(t){for(const[e,s]of this.objects)if(s.mesh&&s.type!=="door_top"&&t.intersectObject(s.mesh,!0).length>0)return s;return null}isPositionOccupied(t,e,s){const i=`${t},${e},${s}`;return this.objects.has(i)}sleep(t){return t?(t.skipToMorning(),!0):!1}openChest(t,e,s){const i=this.getObject(t,e,s);return i&&i.type===71?(i.mesh.userData.lid&&(i.mesh.userData.lid.rotation.x=-Math.PI/4),i.mesh.userData.lock&&(i.mesh.userData.lock.position.z=.35,i.mesh.userData.lock.position.y=.7),i.data.inventory):null}closeChest(t,e,s){const i=this.getObject(t,e,s);i&&i.type===71&&(i.mesh.userData.lid&&(i.mesh.userData.lid.rotation.x=0),i.mesh.userData.lock&&(i.mesh.userData.lock.position.z=.45,i.mesh.userData.lock.position.y=.5))}}const Jt=Math.sqrt(3),Ne=.5*(Jt-1),ft=(3-Jt)/6,je=1/3,X=1/6,mt=y=>Math.floor(y)|0,Vt=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]),Rt=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);function Qt(y=Math.random){const t=ee(y),e=new Float64Array(t).map(i=>Vt[i%12*2]),s=new Float64Array(t).map(i=>Vt[i%12*2+1]);return function(o,r){let a=0,n=0,c=0;const l=(o+r)*Ne,d=mt(o+l),h=mt(r+l),u=(d+h)*ft,p=d-u,f=h-u,m=o-p,g=r-f;let M,v;m>g?(M=1,v=0):(M=0,v=1);const w=m-M+ft,x=g-v+ft,L=m-1+2*ft,A=g-1+2*ft,I=d&255,E=h&255;let N=.5-m*m-g*g;if(N>=0){const O=I+t[E],K=e[O],Z=s[O];N*=N,a=N*N*(K*m+Z*g)}let k=.5-w*w-x*x;if(k>=0){const O=I+M+t[E+v],K=e[O],Z=s[O];k*=k,n=k*k*(K*w+Z*x)}let C=.5-L*L-A*A;if(C>=0){const O=I+1+t[E+1],K=e[O],Z=s[O];C*=C,c=C*C*(K*L+Z*A)}return 70*(a+n+c)}}function te(y=Math.random){const t=ee(y),e=new Float64Array(t).map(o=>Rt[o%12*3]),s=new Float64Array(t).map(o=>Rt[o%12*3+1]),i=new Float64Array(t).map(o=>Rt[o%12*3+2]);return function(r,a,n){let c,l,d,h;const u=(r+a+n)*je,p=mt(r+u),f=mt(a+u),m=mt(n+u),g=(p+f+m)*X,M=p-g,v=f-g,w=m-g,x=r-M,L=a-v,A=n-w;let I,E,N,k,C,O;x>=L?L>=A?(I=1,E=0,N=0,k=1,C=1,O=0):x>=A?(I=1,E=0,N=0,k=1,C=0,O=1):(I=0,E=0,N=1,k=1,C=0,O=1):L<A?(I=0,E=0,N=1,k=0,C=1,O=1):x<A?(I=0,E=1,N=0,k=0,C=1,O=1):(I=0,E=1,N=0,k=1,C=1,O=0);const K=x-I+X,Z=L-E+X,It=A-N+X,Tt=x-k+2*X,Dt=L-C+2*X,zt=A-O+2*X,Et=x-1+3*X,Bt=L-1+3*X,Lt=A-1+3*X,wt=p&255,xt=f&255,kt=m&255;let ct=.6-x*x-L*L-A*A;if(ct<0)c=0;else{const G=wt+t[xt+t[kt]];ct*=ct,c=ct*ct*(e[G]*x+s[G]*L+i[G]*A)}let ht=.6-K*K-Z*Z-It*It;if(ht<0)l=0;else{const G=wt+I+t[xt+E+t[kt+N]];ht*=ht,l=ht*ht*(e[G]*K+s[G]*Z+i[G]*It)}let dt=.6-Tt*Tt-Dt*Dt-zt*zt;if(dt<0)d=0;else{const G=wt+k+t[xt+C+t[kt+O]];dt*=dt,d=dt*dt*(e[G]*Tt+s[G]*Dt+i[G]*zt)}let ut=.6-Et*Et-Bt*Bt-Lt*Lt;if(ut<0)h=0;else{const G=wt+1+t[xt+1+t[kt+1]];ut*=ut,h=ut*ut*(e[G]*Et+s[G]*Bt+i[G]*Lt)}return 32*(c+l+d+h)}}function ee(y){const e=new Uint8Array(512);for(let s=0;s<512/2;s++)e[s]=s;for(let s=0;s<512/2-1;s++){const i=s+~~(y()*(256-s)),o=e[s];e[s]=e[i],e[i]=o}for(let s=256;s<512;s++)e[s]=e[s-256];return e}function qt(y){let t=y>>>0;return function(){t+=1831565813;let e=t;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}class Pe{constructor({world:t,player:e,inventory:s,dayNightManager:i,placeableObjects:o}){this.world=t,this.player=e,this.inventory=s,this.dayNightManager=i,this.placeableObjects=o,this.storageKey="minacraft.save.v1"}ensureSeed(){return this.world?((!this.world.seed||this.world.seed===0)&&(this.world.seed=Date.now()^Math.random()*1e9|0),this.world.seed|0):0}applySeed(t){const e=t|0;if(!this.world)return;this.world.seed=e;const s=qt(e^305419896),i=qt(e^2271560481);this.world.noise2D=Qt(s),this.world.noise3D=te(i)}buildSaveObject(){const t=this.ensureSeed();return{v:1,ts:Date.now(),world:{seed:t,generationVersion:this.world?.generationVersion??0,edits:this.world?.exportEditsForSave?this.world.exportEditsForSave():{}},player:{pos:this.player?.body?.position?[this.player.body.position.x,this.player.body.position.y,this.player.body.position.z]:[0,80,0],yaw:this.player?.yaw??0,pitch:this.player?.pitch??0,health:this.player?.health??null,hunger:this.player?.hunger??null},inventory:{slots:this.inventory?.slots??[],hotbarSlot:this.inventory?.hotbarSlot??0},time:{currentTime:this.dayNightManager?.currentTime??null},objects:this.placeableObjects?.exportState?this.placeableObjects.exportState():[]}}save(){const t=this.buildSaveObject();return localStorage.setItem(this.storageKey,JSON.stringify(t)),t}load(){const t=localStorage.getItem(this.storageKey);if(!t)return null;const e=JSON.parse(t);if(!e||e.v!==1)return null;if(this.applySeed(e.world?.seed??0),this.world?.clearAllChunks&&this.world.clearAllChunks(),this.world?.setEditsFromSave&&this.world.setEditsFromSave(e.world?.edits??{}),this.placeableObjects?.importState&&this.placeableObjects.importState(e.objects??[]),this.inventory&&(this.inventory.slots=Array.isArray(e.inventory?.slots)?e.inventory.slots:new Array(36).fill(null),this.inventory.hotbarSlot=e.inventory?.hotbarSlot??0,this.inventory.uiManager?.updateInventoryUI?.(),this.inventory.uiManager?.updateHotbarSelection?.(this.inventory.hotbarSlot)),this.dayNightManager&&e.time?.currentTime!==null&&e.time?.currentTime!==void 0&&this.dayNightManager.setTime(e.time.currentTime),this.player?.body&&Array.isArray(e.player?.pos)){const[o,r,a]=e.player.pos;this.player.body.position.set(o,r,a),this.player.body.velocity.set(0,0,0)}this.player&&(typeof e.player?.yaw=="number"&&(this.player.yaw=e.player.yaw),typeof e.player?.pitch=="number"&&(this.player.pitch=e.player.pitch),typeof e.player?.health=="number"&&(this.player.health=e.player.health),typeof e.player?.hunger=="number"&&(this.player.hunger=e.player.hunger));const s=this.player?.body?.position?.x??0,i=this.player?.body?.position?.z??0;return this.world?.update?.(s,i,0),e}hasSave(){return!!localStorage.getItem(this.storageKey)}clearSave(){localStorage.removeItem(this.storageKey)}}const U=new ye;U.background=new R(8900331);U.fog=new me(8900331,20,80);const nt=new ge(85,window.innerWidth/window.innerHeight,.1,1e3);U.add(nt);const lt=new be({antialias:!1});lt.setSize(window.innerWidth,window.innerHeight);lt.shadowMap.enabled=!0;lt.shadowMap.type=Me;document.body.appendChild(lt.domElement);document.addEventListener("contextmenu",y=>y.preventDefault());const se=new we(16777215,4473924,.6);se.position.set(0,200,0);U.add(se);const $=new Ht(16777215,.8);$.position.set(50,100,50);$.castShadow=!0;$.shadow.mapSize.width=2048;$.shadow.mapSize.height=2048;$.shadow.camera.near=.5;$.shadow.camera.far=200;$.shadow.camera.left=-50;$.shadow.camera.right=50;$.shadow.camera.top=50;$.shadow.camera.bottom=-50;$.shadow.bias=-5e-4;U.add($);const V=new xe;V.gravity.set(0,-25,0);V.broadphase=new ke(V);V.defaultContactMaterial.friction=0;V.defaultContactMaterial.restitution=0;const rt=new De,Gt=new ze;Gt.load();const _=new Be,H=new Ee(_);_.setInventory(H);const q=new Ie(U,Gt,V);q.noise2D=Qt();q.noise3D=te();const et=new Ae(U),bt=new He(U,q,V),Mt=new Re(U,V,q),ie=new Oe(U,nt),B=new Te(U,nt,V,rt,q,H,ie,Mt,bt,et),Ge=new Le(U),at=new Pe({world:q,player:B,inventory:H,dayNightManager:et,placeableObjects:bt});at.ensureSeed();at.applySeed(q.seed);B.updateHealthUI=()=>Ue();B.openChest=y=>$e(y);globalThis.__mc={scene:U,camera:nt,physicsWorld:V,input:rt,textureManager:Gt,uiManager:_,inventory:H,world:q,player:B,handManager:ie,dayNightManager:et,monsterManager:Mt,placeableObjects:bt};function Ct(y){let t=document.getElementById("toast");t||(t=document.createElement("div"),t.id="toast",t.style.position="fixed",t.style.left="50%",t.style.top="20px",t.style.transform="translateX(-50%)",t.style.background="rgba(0,0,0,0.7)",t.style.color="white",t.style.padding="8px 12px",t.style.borderRadius="6px",t.style.fontFamily="monospace",t.style.zIndex="2000",t.style.pointerEvents="none",document.body.appendChild(t)),t.textContent=y,t.style.display="block",clearTimeout(t.__t),t.__t=setTimeout(()=>t.style.display="none",1500)}q.update(0,0);const Xt=q.getSurfaceY(0,0);Xt!==null&&(B.body.position.y=Xt+2,B.camera.position.y=B.body.position.y+.6);H.add(4,10);H.add(44,20);H.add(40,10);H.add(11,5);H.add(16,3);document.getElementById("hotbar");const Fe=document.getElementById("inventory-screen"),oe=document.getElementById("chest-screen");let Q=!1,Y=!1,P=null;document.addEventListener("keydown",y=>{if(y.code==="KeyE"&&!Y&&(Q=!Q,Fe.style.display=Q?"block":"none",Q?(rt.setPointerLockEnabled(!1),_.updateInventoryUI()):(rt.setPointerLockEnabled(!0),document.body.requestPointerLock())),y.code==="Escape"&&Y&&re(),!Q&&!Y&&y.key>="1"&&y.key<="9"&&H.selectSlot(parseInt(y.key)-1),y.code==="KeyN"&&!Q&&!Y&&(et.setTime(0),console.log("Ð§Ð°Ñ Ð·Ð¼Ñ–Ð½ÐµÐ½Ð¾ Ð½Ð° Ð½Ñ–Ñ‡!")),y.code==="KeyM"&&!Q&&!Y){const e=new F(Math.sin(B.yaw),0,Math.cos(B.yaw)),s=B.body.position.x+e.x*5,i=B.body.position.z+e.z*5,o=Math.floor(B.body.position.y),r=["zombie","skeleton","creeper"],a=r[Math.floor(Math.random()*r.length)];Mt.spawnMonster(a,new F(s,o,i)),console.log(`âœ… Ð—Ð°ÑÐ¿Ð°Ð²Ð½ÐµÐ½Ð¾ ${a} Ð¿ÐµÑ€ÐµÐ´ Ð²Ð°Ð¼Ð¸ Ð½Ð° Ð²Ð¸ÑÐ¾Ñ‚Ñ– ${o}!`)}if(y.code==="KeyD"&&!Q&&!Y&&y.ctrlKey&&(et.setTime(.5),console.log("Ð§Ð°Ñ Ð·Ð¼Ñ–Ð½ÐµÐ½Ð¾ Ð½Ð° Ð´ÐµÐ½ÑŒ!")),y.code==="F5"&&(y.preventDefault(),at.save(),Ct("Saved âœ…")),y.code==="F9"){y.preventDefault();const t=at.load();Ct(t?"Loaded âœ…":"No save found")}});document.getElementById("save-game-btn")?.addEventListener("click",()=>{at.save(),Ct("Saved âœ…")});document.getElementById("load-game-btn")?.addEventListener("click",()=>{const y=at.load();Ct(y?"Loaded âœ…":"No save found")});document.getElementById("chest-close").addEventListener("click",re);window.addEventListener("resize",()=>{nt.aspect=window.innerWidth/window.innerHeight,nt.updateProjectionMatrix(),lt.setSize(window.innerWidth,window.innerHeight)});let Yt=performance.now();const We=1/60;function ne(){requestAnimationFrame(ne);const y=performance.now(),t=(y-Yt)/1e3;Yt=y,!Q&&!Y&&(q.update(B.body.position.x,B.body.position.z,t),B.update(t),et.update(t,B.body.position),Mt.update(t,B,et),Ge.update(t,{x:B.body.position.x,z:B.body.position.z}),V.step(We,t,3)),Ke(),lt.render(U,nt)}function Ue(){const y=document.getElementById("health-bar");if(!y)return;y.innerHTML="";for(let e=0;e<10;e++){const s=document.createElement("div");s.className="heart",e<Math.ceil(B.health/2)?s.textContent=B.health-e*2>=2?"â¤ï¸":"ðŸ’”":s.textContent="ðŸ–¤",y.appendChild(s)}const t=document.getElementById("hunger-bar");if(t){t.innerHTML="";for(let e=0;e<10;e++){const s=document.createElement("div");s.className="food",e<Math.ceil(B.hunger/2)?s.textContent=B.hunger-e*2>=2?"ðŸ—":"ðŸ¦´":s.textContent="âš«",t.appendChild(s)}}}function Ke(){const y=document.getElementById("time-display");if(!y)return;const t=et.getTimeString(),e=et.getTimeOfDay(),s=e==="night"?"ðŸŒ™":e==="day"?"â˜€ï¸":"ðŸŒ…",i=Mt.monsters.length;y.textContent=`${s} ${t} | ðŸ‘¾ ${i}`}function $e(y){Y=!0,P=y,oe.style.display="block",rt.setPointerLockEnabled(!1),bt.openChest(y.position.x,y.position.y,y.position.z),yt()}function re(){Y&&(Y=!1,oe.style.display="none",rt.setPointerLockEnabled(!0),document.body.requestPointerLock(),P&&bt.closeChest(P.position.x,P.position.y,P.position.z),P=null)}function yt(){if(!P)return;const y=document.getElementById("chest-inventory"),t=document.getElementById("chest-player-inventory");if(y){y.innerHTML="";for(let e=0;e<27;e++){const s=P.data.inventory[e],i=document.createElement("div");i.className="inv-slot",i.dataset.chestIndex=e,s&&_.renderItem(i,s),i.addEventListener("click",o=>_t(e,!1,o)),y.appendChild(i)}}if(t){t.innerHTML="";for(let e=0;e<36;e++){const s=H.slots[e],i=document.createElement("div");i.className="inv-slot",i.dataset.playerIndex=e,s&&_.renderItem(i,s),i.addEventListener("click",o=>_t(e,!0,o)),t.appendChild(i)}}}function _t(y,t,e){if(e.shiftKey)if(t){const s=H.slots[y];if(!s)return;const i=P.data.inventory.findIndex(o=>!o);i!==-1&&(P.data.inventory[i]={...s},H.slots[y]=null,yt(),_.updateInventoryUI())}else{const s=P.data.inventory[y];if(!s)return;H.add(s.type,s.count,{skipUI:!0})&&(P.data.inventory[y]=null,yt(),_.updateInventoryUI())}else if(t){const s=H.slots[y];if(!s)return;const i=P.data.inventory.findIndex(o=>!o);i!==-1&&(P.data.inventory[i]={type:s.type,count:1},H.consumeSlot(y,1),yt(),_.updateInventoryUI())}else{const s=P.data.inventory[y];if(!s)return;H.add(s.type,s.count,{skipUI:!0})&&(P.data.inventory[y]=null,yt(),_.updateInventoryUI())}}ne();
